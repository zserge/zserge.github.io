<!doctype html><html lang=en><head><meta charset=utf-8><title>Pennybase: a Pound-Shop BaaS</title><meta name=description content="Building yet another single-file backend as a service. As always, we focus on simplicity, but nevertheless we try to implement as many features as we can without making it too complex."><meta name=author content="Serge Zaitsev"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=data:,><link rel="shortcut icon" sizes=32x32 href=/favicon.png><link rel="shortcut icon" sizes=192x192 href=/favicon-192x192.png><link rel=apple-touch-icon href=/favicon-192x192.png><link rel=alternate type=application/rss+xml title=RSS href=/rss.xml><link rel=canonical href=https://zserge.com/posts/pennybase/><meta property="og:title" content="Pennybase: a Pound-Shop BaaS"><meta property="og:type" content="article"><meta property="og:url" content="https://zserge.com/posts/pennybase/"><meta property="og:image" content="https://zserge.com/logo.png"><meta property="og:description" content="Building yet another single-file backend as a service. As always, we focus on simplicity, but nevertheless we try to implement as many features as we can without making it too complex."><meta property="og:locale" content="en_US"><meta name=twitter:card content="Building yet another single-file backend as a service. As always, we focus on simplicity, but nevertheless we try to implement as many features as we can without making it too complex."><meta name=twitter:site content="@zsergo"><style type=text/css>body{padding:1rem;margin:auto;max-width:46rem;font-family:pt serif,Georgia,Cambria,times new roman,Times,serif;line-height:1.5;font-size:20px;color:rgba(0,0,0,.87);-webkit-font-smoothing:antialiased;font-weight:300}nav{display:flex;justify-content:space-between;align-items:center;margin:1em 0 3em}nav ul,nav li{display:inline-block;list-style:none;margin:0 0 0 .5rem;padding:0}nav ul{margin-right:1rem}.logo{background-color:rgba(0,0,0,.87);color:#fff;min-width:48px;min-height:48px;font-size:28px;border-radius:2px;display:flex;justify-content:center;align-items:center}.logo:hover{color:#fff}h1,h2{line-height:1.2;font-family:roboto,system-ui,segoe ui,Helvetica,Arial,sans-serif;font-weight:400;text-transform:uppercase;margin:1.34em 0 0}h1{font-size:1.95em}h2{font-size:1.25em;border-bottom:2px solid rgba(0,0,0,.87)}h1 a{color:rgba(0,0,0,.87)}p{margin:.67em 0 1em}a{color:#0076df;text-decoration:none;word-break:break-word}a:hover{color:rgba(0,0,0,.87)}ul,ol{list-style-position:outside;margin-left:1em}img{display:block;margin-left:auto;margin-right:auto;max-width:100%}pre,code{font-family:roboto mono,SFMono-Regular,Consolas,liberation mono,Menlo,monospace;font-weight:400;font-size:18px;color:rgba(0,0,0,.6);background:#eee}code{padding:.2rem .4rem;font-size:14px;border-radius:2px}pre{overflow-y:auto;line-height:20px;border-radius:2px;padding:1em}pre code{font-size:14px;padding:0;color:rgba(0,0,0,.87)}footer{font-size:12px}@media(prefers-color-scheme:dark){.logo{color:#444;background-color:#e4e4e4}.logo:hover{color:#444}body,h1 a,h2 a{background-color:#444;color:#e4e4e4}pre,pre code{background:#333;color:#e4e4e4}h2{border-bottom:1px solid #e4e4e4}code{color:#aaa;background:#333}a{color:#e39777}a:hover{color:#e4e4e4}img{filter:grayscale(30%)}}.hl{display:block;width:100%;background-color:#ffc}.ow,.gh,.gp,.gs,.gu,.nt,.nn,.ne,.ni,.nc,.kr,.kn,.kd,.kc,.k{font-weight:700}.c,.ch,.cm,.c1,.cs,.ge{color:#777}</style><link rel="shortcut icon" href=/favicon.ico></head><body><header><nav><a class=logo href=/>Z</a><ul><li><a href=/about/>about</a></li><li><a href=/posts/>posts</a></li><li><a href=https://mastodon.social/@zserge rel=me>@me</a></li><li><a href=https://github.com/zserge rel=me>&lt;/>me</a></li></ul></nav></header><div id=content><h1>Pennybase: a Pound-Shop BaaS</h1><p>So, you want to build a web app, but you are not a backend developer. In that case, it&rsquo;s very tempting to use one of many Backend-as-a-service (BaaS) platforms, such as <a href=https://firebase.google.com>Firebase</a>, <a href=https://supabase.com>Supabase</a>, or even <a href=https://pocketbase.io>PocketBase</a> if you are on a budget.</p><p>But here&rsquo;s a story of yet another toy BaaS, built exclusively for educational purposes (the world needs another side project where the author is the only user, too). It&rsquo;s called <a href=https://github.com/zserge/pennybase>Pennybase</a>, and like many others &ndash; it&rsquo;s a single-file backend-as-a-service written in Go.</p><p>What makes it different is the size (~700 lines of code, 35x smaller than PocketBase), zero external dependencies, and nevertheless &ndash; feature completeness.</p><h2 id=resources-records-schemas>Resources, Records, Schemas</h2><p>We start with data modelling. As in most BaaS, we don&rsquo;t know ahead what kind of data we are going to store. We need a flexible data model. In traditional backends data is stored in relational databases, where each table has a fixed schema and each data model is represented by a structure/record with known fields.</p><p>In Pennybase, we choose a very radical approach: we will be storing data in plain CSV files. This means that our records may only contain string fields, because it&rsquo;s the only data type available to CSV.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>type Record []string
</code></pre></div><p>However, it&rsquo;s not the most convenient way to work with data. Our backend should be able to serve data in a more structured way, such as JSONs. So we treat <code>Record</code> as a low-level storage primitive (like a database table row) and introduce a <code>Resource</code>, which is a collection of named fields, each having a certain type and validation rules.</p><p>To convert Records and Resources we should define <code>Schemas</code>, telling how each field of a Resource becomes a string in Record array (and back).</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Resource</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>any</span>
<span class=kd>type</span> <span class=nx>FieldType</span> <span class=kt>string</span>

<span class=kd>const</span> <span class=p>(</span>
  <span class=nx>Number</span> <span class=nx>FieldType</span> <span class=p>=</span> <span class=s>&#34;number&#34;</span>
  <span class=nx>Text</span>   <span class=nx>FieldType</span> <span class=p>=</span> <span class=s>&#34;text&#34;</span>
  <span class=nx>List</span>   <span class=nx>FieldType</span> <span class=p>=</span> <span class=s>&#34;list&#34;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>FieldSchema</span> <span class=kd>struct</span> <span class=p>{</span>
  <span class=nx>Resource</span> <span class=kt>string</span>    
  <span class=nx>Field</span>    <span class=kt>string</span>   
  <span class=nx>Type</span>     <span class=nx>FieldType</span>
  <span class=nx>Min</span>      <span class=kt>float64</span> 
  <span class=nx>Max</span>      <span class=kt>float64</span>
  <span class=nx>Regex</span>    <span class=kt>string</span> 
<span class=p>}</span>
<span class=kd>type</span> <span class=nx>Schema</span> <span class=p>[]</span><span class=nx>FieldSchema</span>
</code></pre></div><p>We limit ourselves to only strings, numbers and string lists. This roughly corresponds to JSON types, if we replace boolean with 0/1 and disallow nested objects.</p><p>Let&rsquo;s also introduce basic validation rules: min/max for numbers and regular expressions for strings. These are optional but they can be useful to validate &ldquo;booleans&rdquo; (min=0, max=1), enumerations (regex=<code>^(foo|bar)$</code>), and other things.</p><p>We can now use Schema to convert Records to Resources and back:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>field</span> <span class=nx>FieldSchema</span><span class=p>)</span> <span class=nf>Validate</span><span class=p>(</span><span class=nx>v</span> <span class=nx>any</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
  <span class=k>if</span> <span class=nx>v</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span> <span class=k>return</span> <span class=kc>false</span> <span class=p>}</span>
  <span class=k>switch</span> <span class=nx>field</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
  <span class=k>case</span> <span class=nx>Number</span><span class=p>:</span>
    <span class=nx>n</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.(</span><span class=kt>float64</span><span class=p>)</span>
    <span class=k>return</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=p>((</span><span class=nx>field</span><span class=p>.</span><span class=nx>Min</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>field</span><span class=p>.</span><span class=nx>Max</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=nx>n</span> <span class=o>&gt;=</span> <span class=nx>field</span><span class=p>.</span><span class=nx>Min</span> <span class=o>&amp;&amp;</span> <span class=nx>n</span> <span class=o>&lt;=</span> <span class=nx>field</span><span class=p>.</span><span class=nx>Max</span><span class=p>))</span>
  <span class=k>case</span> <span class=nx>Text</span><span class=p>:</span>
    <span class=nx>s</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.(</span><span class=kt>string</span><span class=p>)</span>
    <span class=k>return</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>field</span><span class=p>.</span><span class=nx>Regex</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>||</span> <span class=nx>regexp</span><span class=p>.</span><span class=nf>MustCompile</span><span class=p>(</span><span class=nx>field</span><span class=p>.</span><span class=nx>Regex</span><span class=p>).</span><span class=nf>MatchString</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span>
  <span class=k>case</span> <span class=nx>List</span><span class=p>:</span>
    <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.([]</span><span class=kt>string</span><span class=p>)</span>
    <span class=k>return</span> <span class=nx>ok</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=kc>false</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>Schema</span><span class=p>)</span> <span class=nf>Record</span><span class=p>(</span><span class=nx>res</span> <span class=nx>Resource</span><span class=p>)</span> <span class=p>(</span><span class=nx>Record</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>rec</span> <span class=o>:=</span> <span class=nx>Record</span><span class=p>{}</span>
  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>field</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span> <span class=p>{</span>
    <span class=nx>v</span> <span class=o>:=</span> <span class=nx>res</span><span class=p>[</span><span class=nx>field</span><span class=p>.</span><span class=nx>Field</span><span class=p>]</span>
    <span class=k>if</span> <span class=nx>v</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
      <span class=nx>v</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>FieldType</span><span class=p>]</span><span class=nx>any</span><span class=p>{</span><span class=nx>Number</span><span class=p>:</span> <span class=mf>0.0</span><span class=p>,</span> <span class=nx>Text</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>List</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{}}[</span><span class=nx>field</span><span class=p>.</span><span class=nx>Type</span><span class=p>]</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>!</span><span class=nx>field</span><span class=p>.</span><span class=nf>Validate</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid field \&#34;%s\&#34;&#34;</span><span class=p>,</span> <span class=nx>field</span><span class=p>.</span><span class=nx>Field</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>switch</span> <span class=nx>field</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>Number</span><span class=p>:</span> <span class=nx>rec</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>rec</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%g&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>))</span>
    <span class=k>case</span> <span class=nx>Text</span><span class=p>:</span> <span class=nx>rec</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>rec</span><span class=p>,</span> <span class=nx>v</span><span class=p>.(</span><span class=kt>string</span><span class=p>))</span>
    <span class=k>case</span> <span class=nx>List</span><span class=p>:</span> <span class=nx>rec</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>rec</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>v</span><span class=p>.([]</span><span class=kt>string</span><span class=p>),</span> <span class=s>&#34;,&#34;</span><span class=p>))</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>rec</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>Schema</span><span class=p>)</span> <span class=nf>Resource</span><span class=p>(</span><span class=nx>rec</span> <span class=nx>Record</span><span class=p>)</span> <span class=p>(</span><span class=nx>Resource</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>res</span> <span class=o>:=</span> <span class=nx>Resource</span><span class=p>{}</span>
  <span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>field</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span> <span class=p>{</span>
    <span class=k>switch</span> <span class=nx>field</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>Number</span><span class=p>:</span>
      <span class=nx>n</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseFloat</span><span class=p>(</span><span class=nx>rec</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=mi>64</span><span class=p>)</span>
      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
      <span class=p>}</span>
      <span class=nx>res</span><span class=p>[</span><span class=nx>field</span><span class=p>.</span><span class=nx>Field</span><span class=p>]</span> <span class=p>=</span> <span class=nx>n</span>
    <span class=k>case</span> <span class=nx>Text</span><span class=p>:</span> <span class=nx>res</span><span class=p>[</span><span class=nx>field</span><span class=p>.</span><span class=nx>Field</span><span class=p>]</span> <span class=p>=</span> <span class=nx>rec</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
    <span class=k>case</span> <span class=nx>List</span><span class=p>:</span>
      <span class=k>if</span> <span class=nx>rec</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
        <span class=nx>res</span><span class=p>[</span><span class=nx>field</span><span class=p>.</span><span class=nx>Field</span><span class=p>]</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>rec</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=s>&#34;,&#34;</span><span class=p>)</span>
      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>res</span><span class=p>[</span><span class=nx>field</span><span class=p>.</span><span class=nx>Field</span><span class=p>]</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{}</span>
      <span class=p>}</span>
    <span class=k>default</span><span class=p>:</span> <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unknown field type %s&#34;</span><span class=p>,</span> <span class=nx>field</span><span class=p>.</span><span class=nx>Type</span><span class=p>)</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>res</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>Now we can freely convert Resources and Records, while being sure that our data fields are more or less valid. Here&rsquo;s an example to play with: <a href=https://go.dev/play/p/BCh5kIY_Aih>https://go.dev/play/p/BCh5kIY_Aih</a></p><h2 id=csv-storage>CSV storage</h2><p>Now that we have a data model, we should find a way to store it on disk. We go with CSV files, a format that everyone <a href=https://github.com/medialab/xan/blob/master/docs/LOVE_LETTER.md>likes to write</a>, but hates to read.</p><p>We start with an interface to our &ldquo;database&rdquo;. Later we might want to choose a proper storage, like SQLite or some document store, or introduce caching and indexing without breaking the rest of the code:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>DB</span> <span class=kd>interface</span> <span class=p>{</span>
  <span class=nf>Create</span><span class=p>(</span><span class=nx>r</span> <span class=nx>Record</span><span class=p>)</span> <span class=kt>error</span>
  <span class=nf>Update</span><span class=p>(</span><span class=nx>r</span> <span class=nx>Record</span><span class=p>)</span> <span class=kt>error</span>
  <span class=nf>Get</span><span class=p>(</span><span class=nx>id</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>Record</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
  <span class=nf>Delete</span><span class=p>(</span><span class=nx>id</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span>
  <span class=nf>Iter</span><span class=p>()</span> <span class=kd>func</span><span class=p>(</span><span class=nx>yield</span> <span class=kd>func</span><span class=p>(</span><span class=nx>Record</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=kt>bool</span><span class=p>)</span>
  <span class=nf>Close</span><span class=p>()</span> <span class=kt>error</span>
<span class=p>}</span>
</code></pre></div><p>Nothing unusual here, regular <a href=https://en.wikipedia.org/wiki/Create,_read,_update_and_delete>CRUD</a> operations and an iterator. Implementation can also be trivial: for each operation we open the file, read it, modify in memory and write back atomically (i.e. write to temporary file and rename it back).</p><p>However, in this case I think we should take an extra step and try to make it a bit more optimal. First, we may choose to only append data to a CSV file. In this case writes would be very fast, but reads would require scanning the full file to find the last written record. We can fix it by caching last known record offsets in memory. Thankfully, Go CSV reader has a <a href=https://pkg.go.dev/encoding/csv#Reader.InputOffset>method</a> to return current offset in the file after a record has been read.</p><p>So, when a DB is created - we read the file and store offsets of each record in a map. When we write a record - we append a row and update an offset. To read a record we check the offset, seek to it and read the record.</p><p>What stays unclear is how to handle deletes and how to identify records. A typical way is to use optimistic concurrency. Each record has a unique string ID and a numeric version (starting with 1). These two fields would be mandatory to all records and resources, we would have to update Schema to include them all the time and validate properly.</p><p>At the database level we increase the version each time the record is updated and set version to zero once it&rsquo;s deleted. We also cache latest versions in memory to avoid concurrent writes. The client should pass the latest version they have, and if two clients are writing at the same time &ndash; the first one would succeed and increase the version, while the other one will fail because the versions wouldn&rsquo;t match anymore.</p><p>All together it gives us a &ldquo;database&rdquo; like this:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>db</span> <span class=kd>struct</span> <span class=p>{</span>
  <span class=nx>mu</span>      <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
  <span class=nx>f</span>       <span class=o>*</span><span class=nx>os</span><span class=p>.</span><span class=nx>File</span>
  <span class=nx>w</span>       <span class=o>*</span><span class=nx>csv</span><span class=p>.</span><span class=nx>Writer</span>
  <span class=nx>index</span>   <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int64</span>
  <span class=nx>version</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int64</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>Open</span><span class=p>(</span><span class=nx>path</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>DB</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>f</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>OpenFile</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>O_RDWR</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_CREATE</span><span class=p>|</span><span class=nx>os</span><span class=p>.</span><span class=nx>O_APPEND</span><span class=p>,</span> <span class=mo>0644</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span> <span class=p>}</span>
  <span class=nx>db</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>db</span><span class=p>{</span><span class=nx>f</span><span class=p>:</span> <span class=nx>f</span><span class=p>,</span> <span class=nx>w</span><span class=p>:</span> <span class=nx>csv</span><span class=p>.</span><span class=nf>NewWriter</span><span class=p>(</span><span class=nx>f</span><span class=p>),</span> <span class=nx>index</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int64</span><span class=p>{},</span> <span class=nx>version</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int64</span><span class=p>{}}</span>
  <span class=nx>r</span> <span class=o>:=</span> <span class=nx>csv</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
  <span class=nx>r</span><span class=p>.</span><span class=nx>FieldsPerRecord</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span> <span class=c1>// deleted records have only 2 field: id and version=0
</span><span class=c1></span>  <span class=k>for</span> <span class=p>{</span>
    <span class=nx>pos</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>InputOffset</span><span class=p>()</span>
    <span class=nx>rec</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Read</span><span class=p>()</span>
    <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span><span class=p>)</span> <span class=p>{</span> <span class=k>break</span> <span class=p>}</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span> <span class=p>}</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rec</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
      <span class=nx>db</span><span class=p>.</span><span class=nx>index</span><span class=p>[</span><span class=nx>rec</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span> <span class=p>=</span> <span class=nx>pos</span>
      <span class=nx>db</span><span class=p>.</span><span class=nx>version</span><span class=p>[</span><span class=nx>rec</span><span class=p>[</span><span class=mi>0</span><span class=p>]],</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>rec</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>db</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>db</span><span class=p>)</span> <span class=nb>append</span><span class=p>(</span><span class=nx>r</span> <span class=nx>Record</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
  <span class=nx>pos</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nf>Seek</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>io</span><span class=p>.</span><span class=nx>SeekEnd</span><span class=p>)</span>
  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>err</span>
  <span class=p>}</span>
  <span class=nx>db</span><span class=p>.</span><span class=nx>w</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span>
  <span class=nx>db</span><span class=p>.</span><span class=nx>index</span><span class=p>[</span><span class=nx>r</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span> <span class=p>=</span> <span class=nx>pos</span>
  <span class=nx>db</span><span class=p>.</span><span class=nx>version</span><span class=p>[</span><span class=nx>r</span><span class=p>[</span><span class=mi>0</span><span class=p>]],</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>r</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
  <span class=k>return</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=c1>// Now we can call db.append() from db.Create(), db.Update(), and db.Delete()
</span><span class=c1>// Create: ensure that version==&#34;1&#34; and record doesn&#39;t exist in cache
</span><span class=c1>// Update: ensure that version==current+1 and record exists in cache
</span><span class=c1>// Delete: ensure that record exists in cache
</span><span class=c1>// For simplicity these methods are omitted here.
</span><span class=c1></span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>db</span><span class=p>)</span> <span class=nf>Get</span><span class=p>(</span><span class=nx>id</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>Record</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
  <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
  <span class=k>if</span> <span class=nx>db</span><span class=p>.</span><span class=nx>version</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>&lt;</span> <span class=mi>1</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;record not found&#34;</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=nx>offset</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>index</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
  <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nf>Seek</span><span class=p>(</span><span class=nx>offset</span><span class=p>,</span> <span class=nx>io</span><span class=p>.</span><span class=nx>SeekStart</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
  <span class=p>}</span>
  <span class=nx>r</span> <span class=o>:=</span> <span class=nx>csv</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>f</span><span class=p>)</span>
  <span class=nx>rec</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Read</span><span class=p>()</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rec</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>rec</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=nx>id</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;corrupted index&#34;</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>rec</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>db</span><span class=p>)</span> <span class=nf>Iter</span><span class=p>()</span> <span class=kd>func</span><span class=p>(</span><span class=nx>yield</span> <span class=kd>func</span><span class=p>(</span><span class=nx>Record</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>yield</span> <span class=kd>func</span><span class=p>(</span><span class=nx>Record</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
    <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>f</span><span class=p>.</span><span class=nf>Seek</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>io</span><span class=p>.</span><span class=nx>SeekStart</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
      <span class=nf>yield</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
      <span class=k>return</span>
    <span class=p>}</span>
    <span class=nx>r</span> <span class=o>:=</span> <span class=nx>csv</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>f</span><span class=p>)</span>
    <span class=nx>r</span><span class=p>.</span><span class=nx>FieldsPerRecord</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
    <span class=k>for</span> <span class=p>{</span>
      <span class=nx>rec</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Read</span><span class=p>()</span>
      <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>break</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nf>yield</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=k>return</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rec</span><span class=p>)</span> <span class=p>&lt;</span> <span class=mi>2</span> <span class=p>{</span>
        <span class=k>continue</span>
      <span class=p>}</span>
      <span class=nx>id</span><span class=p>,</span> <span class=nx>version</span> <span class=o>:=</span> <span class=nx>rec</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>rec</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
      <span class=k>if</span> <span class=nx>version</span> <span class=o>==</span> <span class=s>&#34;0&#34;</span> <span class=o>||</span> <span class=nx>version</span> <span class=o>!=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>FormatInt</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>version</span><span class=p>[</span><span class=nx>id</span><span class=p>],</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>continue</span> <span class=c1>// deleted items or outdated versions
</span><span class=c1></span>      <span class=p>}</span>
      <span class=k>if</span> <span class=p>!</span><span class=nf>yield</span><span class=p>(</span><span class=nx>rec</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Despite its simplicity this CSV storage is quite fast and powerful. I think <a href=https://arpitbhayani.me/blogs/bitcask/>Bitcask</a> uses a similar approach of having an append-only log with an index holding the keys mapped to the necessary lookup information. Quick benchmarks show that both writes and reads take a few microseconds, so we can proceed building abstractions on top of this poor man&rsquo;s &ldquo;database&rdquo;.</p><p>You can play with it here: <a href=https://go.dev/play/p/q4PtWb9SvvA>https://go.dev/play/p/q4PtWb9SvvA</a></p><h2 id=store>Store</h2><p>A store is the least interesting part of Pennybase, because it&rsquo;s essentially a collection of <code>DB</code> instances and a global cache for Schemas. We assume that Schemas are immutable and can only be loaded once when the store is created:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Store</span> <span class=kd>struct</span> <span class=p>{</span>
  <span class=nx>Dir</span>       <span class=kt>string</span>
  <span class=nx>Schemas</span>   <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>Schema</span>
  <span class=nx>Resources</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>DB</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>NewStore</span><span class=p>(</span><span class=nx>dir</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Store</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>s</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Store</span><span class=p>{</span><span class=nx>Dir</span><span class=p>:</span> <span class=nx>dir</span><span class=p>,</span> <span class=nx>Schemas</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>Schema</span><span class=p>{},</span> <span class=nx>Resources</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>DB</span><span class=p>{}}</span>
  <span class=nx>schemaDB</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>NewCSVDB</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Dir</span> <span class=o>+</span> <span class=s>&#34;/_schemas.csv&#34;</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
  <span class=p>}</span>
  <span class=k>for</span> <span class=nx>rec</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>schemaDB</span><span class=p>.</span><span class=nf>Iter</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rec</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>8</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid schema record: %v&#34;</span><span class=p>,</span> <span class=nx>rec</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>schema</span> <span class=o>:=</span> <span class=nx>FieldSchema</span><span class=p>{</span><span class=nx>Resource</span><span class=p>:</span> <span class=nx>rec</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nx>Field</span><span class=p>:</span> <span class=nx>rec</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=nx>Type</span><span class=p>:</span> <span class=nf>FieldType</span><span class=p>(</span><span class=nx>rec</span><span class=p>[</span><span class=mi>4</span><span class=p>]),</span> <span class=nx>Regex</span><span class=p>:</span> <span class=nx>rec</span><span class=p>[</span><span class=mi>7</span><span class=p>]}</span>
    <span class=nx>schema</span><span class=p>.</span><span class=nx>Min</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseFloat</span><span class=p>(</span><span class=nx>rec</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=mi>64</span><span class=p>)</span>
    <span class=nx>schema</span><span class=p>.</span><span class=nx>Max</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseFloat</span><span class=p>(</span><span class=nx>rec</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=mi>64</span><span class=p>)</span>
    <span class=nx>s</span><span class=p>.</span><span class=nx>Schemas</span><span class=p>[</span><span class=nx>schema</span><span class=p>.</span><span class=nx>Resource</span><span class=p>]</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Schemas</span><span class=p>[</span><span class=nx>schema</span><span class=p>.</span><span class=nx>Resource</span><span class=p>],</span> <span class=nx>schema</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Resources</span><span class=p>[</span><span class=nx>schema</span><span class=p>.</span><span class=nx>Resource</span><span class=p>];</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
      <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>NewCSVDB</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Dir</span> <span class=o>+</span> <span class=s>&#34;/&#34;</span> <span class=o>+</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>Resource</span> <span class=o>+</span> <span class=s>&#34;.csv&#34;</span><span class=p>)</span>
      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
      <span class=p>}</span>
      <span class=nx>s</span><span class=p>.</span><span class=nx>Resources</span><span class=p>[</span><span class=nx>schema</span><span class=p>.</span><span class=nx>Resource</span><span class=p>]</span> <span class=p>=</span> <span class=nx>db</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>s</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>Here the store loads all resource schemas, and for each resource defined in a schema catalogue it opens a new CSV database. The rest of the Store operations simply delegates the Resource to the underlying DB, converting it into a Record first:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Store</span><span class=p>)</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>resource</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>r</span> <span class=nx>Resource</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>db</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Resources</span><span class=p>[</span><span class=nx>resource</span><span class=p>]</span>
  <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;resource %s not found&#34;</span><span class=p>,</span> <span class=nx>resource</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=nx>newID</span> <span class=o>:=</span> <span class=nf>ID</span><span class=p>()</span>
  <span class=nx>r</span><span class=p>[</span><span class=s>&#34;_id&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>newID</span>
  <span class=nx>r</span><span class=p>[</span><span class=s>&#34;_v&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=mf>1.0</span>
  <span class=nx>rec</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Schemas</span><span class=p>[</span><span class=nx>resource</span><span class=p>].</span><span class=nf>Record</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>rec</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>newID</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Store</span><span class=p>)</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>resource</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>r</span> <span class=nx>Resource</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Store</span><span class=p>)</span> <span class=nf>Delete</span><span class=p>(</span><span class=nx>resource</span><span class=p>,</span> <span class=nx>id</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Store</span><span class=p>)</span> <span class=nf>Get</span><span class=p>(</span><span class=nx>resource</span><span class=p>,</span> <span class=nx>id</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>Resource</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Store</span><span class=p>)</span> <span class=nf>List</span><span class=p>(</span><span class=nx>resource</span><span class=p>,</span> <span class=nx>sortBy</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=nx>Resource</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span> <span class=o>...</span> <span class=p>}</span>
</code></pre></div><p>The <code>List</code> method takes an optional <code>sortBy</code> because otherwise the order of iteration would be inconsistent if the records get updated: the last updated item would appear the last in the list, even if it was the first one created.</p><p>This is a terribly inefficient sorting approach, as it keeps all data in memory, but since DB is an interface &ndash; might consider building a search index to optimise listing, filtering and sorting later.</p><p>Anyway, we now have a generic store, capable of serving JSON-like Resources. Time to add HTTP API to it.</p><h2 id=http-api>HTTP API</h2><p>This is where Go shines, especially with the new ServeMux. We can create a full REST API for our Store in a few lines of code:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span> <span class=p>{</span>
  <span class=nx>store</span>  <span class=o>*</span><span class=nx>Store</span>
  <span class=nx>mux</span>    <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>ServeMux</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>NewServer</span><span class=p>(</span><span class=nx>store</span> <span class=o>*</span><span class=nx>Store</span><span class=p>,</span> <span class=nx>tmplDir</span><span class=p>,</span> <span class=nx>staticDir</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>Server</span> <span class=p>{</span>
  <span class=nx>s</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Server</span><span class=p>{</span>
    <span class=nx>store</span><span class=p>:</span>  <span class=nx>store</span><span class=p>,</span>
    <span class=nx>mux</span><span class=p>:</span>    <span class=nx>http</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>(),</span>
  <span class=p>}</span>
  <span class=nx>s</span><span class=p>.</span><span class=nx>mux</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;GET /api/{resource}/&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>handleList</span><span class=p>)</span>
  <span class=nx>s</span><span class=p>.</span><span class=nx>mux</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;POST /api/{resource}/&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>handleCreate</span><span class=p>)</span>
  <span class=nx>s</span><span class=p>.</span><span class=nx>mux</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;GET /api/{resource}/{id}&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>handleGet</span><span class=p>)</span>
  <span class=nx>s</span><span class=p>.</span><span class=nx>mux</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;PUT /api/{resource}/{id}&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>handleUpdate</span><span class=p>)</span>
  <span class=nx>s</span><span class=p>.</span><span class=nx>mux</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;DELETE /api/{resource}/{id}&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>handleDelete</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>tmplDir</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>tmpl</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>template</span><span class=p>.</span><span class=nf>ParseGlob</span><span class=p>(</span><span class=nx>filepath</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>tmplDir</span><span class=p>,</span> <span class=s>&#34;*&#34;</span><span class=p>));</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
      <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>t</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tmpl</span><span class=p>.</span><span class=nf>Templates</span><span class=p>()</span> <span class=p>{</span>
        <span class=nx>s</span><span class=p>.</span><span class=nx>mux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;GET /%s&#34;</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Name</span><span class=p>()),</span> <span class=nx>s</span><span class=p>.</span><span class=nf>handleTemplate</span><span class=p>(</span><span class=nx>tmpl</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Name</span><span class=p>()))</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=nx>staticDir</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
    <span class=nx>s</span><span class=p>.</span><span class=nx>mux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;GET /static/&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nf>StripPrefix</span><span class=p>(</span><span class=s>&#34;/static/&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nf>FileServer</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>Dir</span><span class=p>(</span><span class=nx>staticDir</span><span class=p>))))</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=nx>s</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>Handler</span><span class=p>()</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
  <span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// we can run some middleware here, if needed
</span><span class=c1></span>    <span class=nx>s</span><span class=p>.</span><span class=nx>mux</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
  <span class=p>})</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>handleList</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>store</span><span class=p>.</span><span class=nf>List</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>PathValue</span><span class=p>(</span><span class=s>&#34;resource&#34;</span><span class=p>),</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
    <span class=k>return</span>
  <span class=p>}</span>
  <span class=nx>_</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>res</span><span class=p>)</span>
<span class=p>}</span>

<span class=c1>// similarly, we implement handleCreate, handleGet, handleUpdate, handleDelete
</span></code></pre></div><p>Finally, we can run our server and try it out:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=nx>store</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>NewStore</span><span class=p>(</span><span class=s>&#34;data&#34;</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Error initializing store:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
<span class=p>}</span>
<span class=nx>server</span> <span class=o>:=</span> <span class=nf>NewServer</span><span class=p>(</span><span class=nx>store</span><span class=p>,</span> <span class=s>&#34;web/templates&#34;</span><span class=p>,</span> <span class=s>&#34;web/static&#34;</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Error initializing server:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
  <span class=k>return</span>
<span class=p>}</span>
<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>,</span> <span class=nx>server</span><span class=p>.</span><span class=nf>Handler</span><span class=p>()))</span>
</code></pre></div><p>It should be able to serve static files, such as JS or CSS, Go templates, that can render data from Store and provide a REST API to manipulate collections of resources:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -X POST --json <span class=s1>&#39;{&#34;title&#34;: &#34;foo&#34;, &#34;tags&#34;: [&#34;bar&#34;, &#34;baz&#34;]}&#39;</span> http://localhost:8080/api/posts/

TODO
</code></pre></div><h2 id=authentication-and-authorization>Authentication and Authorization</h2><p>So far we have a working BaaS, as long as you trust your users not to erase each other&rsquo;s data. Time to improve the security.</p><p>We introduce two more special files: <code>_users.csv</code> and <code>_permissions.csv</code>.</p><p>User list is a simple CSV file with a list of users and their hashed passwords. We also keep a list of roles for each user to implement some minimal role-based access control (<a href=https://en.wikipedia.org/wiki/Role-based_access_control>RBAC</a>).</p><p>Having a list of users we can authenticate them using a simple HTTP Basic Auth. It shouldn&rsquo;t be too hard to also implement OAuth and user sessions later, but let&rsquo;s start simple.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Store</span><span class=p>)</span> <span class=nf>authenticate</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>password</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>db</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Resources</span><span class=p>[</span><span class=s>&#34;_users&#34;</span><span class=p>]</span>
  <span class=nx>rec</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>username</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;user not found&#34;</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=nx>userRes</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Schemas</span><span class=p>[</span><span class=s>&#34;_users&#34;</span><span class=p>].</span><span class=nf>Resource</span><span class=p>(</span><span class=nx>rec</span><span class=p>)</span>
  <span class=nx>storedHash</span> <span class=o>:=</span> <span class=nx>userRes</span><span class=p>[</span><span class=s>&#34;password&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>)</span>
  <span class=nx>salt</span> <span class=o>:=</span> <span class=nx>userRes</span><span class=p>[</span><span class=s>&#34;salt&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>)</span>
  <span class=k>if</span> <span class=nf>hashPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=nx>salt</span><span class=p>)</span> <span class=o>!=</span> <span class=nx>storedHash</span> <span class=p>{</span>
    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;invalid credentials&#34;</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=nx>roles</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>userRes</span><span class=p>[</span><span class=s>&#34;roles&#34;</span><span class=p>].([]</span><span class=kt>string</span><span class=p>)</span>
  <span class=k>return</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>roles</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>Permissions are a bit more complex. Each row of the <code>_permissions</code> collection describes a single access rule, telling that a certain resource can be accessed by a certain role or by a certain owner.</p><p>We try to support two use cases here, similar to the UNIX file permissions. The first case is owner-based permissions. When a resource is created its owner username is stored in the record. Permission check then compares the owner field of a resource with the username and if they are the same - permission is granted:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>id,version,resource,action,ref,role

1,1,posts,create,*,
2,1,posts,read,*,
3,1,posts,delete,owner,
4,1,posts,update,owner,
</code></pre></div><p>In this example &ldquo;posts&rdquo; resource can be created and read by anyone, but can only be updated or deleted by the username stored in the &ldquo;owner&rdquo; field of the post.</p><p>The second use case is a role-based approach, similar to &ldquo;group&rdquo; permissions in UNIX. In this case we check if the user has a certain role and if so - grant permission to access the resource:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>1,1,posts,create,,&#34;*&#34;
1,1,posts,read,,&#34;viewer&#34;
1,1,posts,delete,,&#34;editor,moderator&#34;
1,1,posts,update,,&#34;editor,moderator&#34;
</code></pre></div><p>Here we say that anyone with the role &ldquo;viewer&rdquo; can see the posts, but only editor and moderators can update them.</p><p>Permission check remains simple:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Store</span><span class=p>)</span> <span class=nf>checkPermissions</span><span class=p>(</span><span class=nx>resource</span><span class=p>,</span> <span class=nx>action</span><span class=p>,</span> <span class=nx>user</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>roles</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>res</span> <span class=nx>Resource</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
  <span class=nx>permissions</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>List</span><span class=p>(</span><span class=s>&#34;_permissions&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>permissions</span> <span class=p>{</span>
    <span class=nx>act</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>[</span><span class=s>&#34;action&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>p</span><span class=p>[</span><span class=s>&#34;resource&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>)</span> <span class=o>!=</span> <span class=nx>resource</span> <span class=o>||</span> <span class=p>(</span><span class=nx>act</span> <span class=o>!=</span> <span class=s>&#34;*&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>act</span> <span class=o>!=</span> <span class=nx>action</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>continue</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>ref</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>[</span><span class=s>&#34;ref&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>);</span> <span class=nx>ref</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
      <span class=k>if</span> <span class=nx>res</span><span class=p>[</span><span class=nx>ref</span><span class=p>]</span> <span class=o>==</span> <span class=nx>user</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>true</span>
      <span class=p>}</span>
      <span class=k>continue</span>
    <span class=p>}</span>
    <span class=nx>role</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>[</span><span class=s>&#34;role&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>role</span> <span class=o>==</span> <span class=s>&#34;*&#34;</span> <span class=o>||</span> <span class=nx>slices</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>roles</span><span class=p>,</span> <span class=nx>role</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>true</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=kc>false</span>
<span class=p>}</span>
</code></pre></div><p>Although it&rsquo;s far from being great (we scan all permissions all the time), there are many ways to speed it up.</p><h2 id=real-time-database>Real-time database</h2><p>Most BaaS-es position themselves as real-time databases, meaning that one can watch all the updates happening to the collection of resources as they happen, typically over a websocket.</p><p>We can implement a similar mechanism, but using a simpler alternative - <a href=https://developer.mozilla.org/de/docs/Web/API/Server-sent_events>server-side events</a>.</p><p>Let&rsquo;s add a local in-process pub/sub broker to our server:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>Broker</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>channels</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>map</span><span class=p>[</span><span class=kd>chan</span> <span class=nx>Event</span><span class=p>]</span><span class=kt>bool</span> <span class=c1>// resource -&gt; channels
</span><span class=c1></span>	<span class=nx>mu</span>       <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>Broker</span><span class=p>)</span> <span class=nf>Subscribe</span><span class=p>(</span><span class=nx>resource</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>ch</span> <span class=kd>chan</span> <span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
	<span class=k>defer</span> <span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
	<span class=k>if</span> <span class=nx>b</span><span class=p>.</span><span class=nx>channels</span><span class=p>[</span><span class=nx>resource</span><span class=p>]</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>b</span><span class=p>.</span><span class=nx>channels</span><span class=p>[</span><span class=nx>resource</span><span class=p>]</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kd>chan</span> <span class=nx>Event</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>b</span><span class=p>.</span><span class=nx>channels</span><span class=p>[</span><span class=nx>resource</span><span class=p>][</span><span class=nx>ch</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>Broker</span><span class=p>)</span> <span class=nf>Unsubscribe</span><span class=p>(</span><span class=nx>resource</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>ch</span> <span class=kd>chan</span> <span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
	<span class=k>defer</span> <span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
	<span class=k>if</span> <span class=nx>subs</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>channels</span><span class=p>[</span><span class=nx>resource</span><span class=p>];</span> <span class=nx>subs</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nb>delete</span><span class=p>(</span><span class=nx>subs</span><span class=p>,</span> <span class=nx>ch</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>Broker</span><span class=p>)</span> <span class=nf>Publish</span><span class=p>(</span><span class=nx>resource</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>evt</span> <span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
	<span class=k>defer</span> <span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
	<span class=k>if</span> <span class=nx>subs</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>channels</span><span class=p>[</span><span class=nx>resource</span><span class=p>];</span> <span class=nx>subs</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>for</span> <span class=nx>ch</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>subs</span> <span class=p>{</span>
			<span class=k>select</span> <span class=p>{</span>
			<span class=k>case</span> <span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>evt</span><span class=p>:</span>
			<span class=k>default</span><span class=p>:</span>
			<span class=p>}</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Event</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>Action</span> <span class=kt>string</span>   <span class=s>`json:&#34;action&#34;`</span>
	<span class=nx>ID</span>     <span class=kt>string</span>   <span class=s>`json:&#34;id&#34;`</span>
	<span class=nx>Data</span>   <span class=nx>Resource</span> <span class=s>`json:&#34;data&#34;`</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>Store</span>  <span class=o>*</span><span class=nx>Store</span>
	<span class=nx>Broker</span> <span class=o>*</span><span class=nx>Broker</span>
	<span class=nx>Mux</span>    <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>ServeMux</span>
<span class=p>}</span>
</code></pre></div><p>We can now do <code>srv.Broker.Publish()</code> to emit events when a resource has been modified. We can also create an endpoint <code>/api/events/{resource}</code> that would use server-side events to listen to resource changes:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>handleEvents</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>flusher</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.(</span><span class=nx>http</span><span class=p>.</span><span class=nx>Flusher</span><span class=p>)</span>
  <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
    <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;SSE not supported&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
    <span class=k>return</span>
  <span class=p>}</span>
  <span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;text/event-stream&#34;</span><span class=p>)</span>
  <span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Cache-Control&#34;</span><span class=p>,</span> <span class=s>&#34;no-cache&#34;</span><span class=p>)</span>
  <span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Connection&#34;</span><span class=p>,</span> <span class=s>&#34;keep-alive&#34;</span><span class=p>)</span>
  <span class=nx>resource</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>PathValue</span><span class=p>(</span><span class=s>&#34;resource&#34;</span><span class=p>)</span>
  <span class=nx>user</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Store</span><span class=p>.</span><span class=nf>Authenticate</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;unauthenticated&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
    <span class=k>return</span>
  <span class=p>}</span>
  <span class=nx>events</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Event</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
  <span class=nx>s</span><span class=p>.</span><span class=nx>Broker</span><span class=p>.</span><span class=nf>Subscribe</span><span class=p>(</span><span class=nx>resource</span><span class=p>,</span> <span class=nx>events</span><span class=p>)</span>
  <span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Broker</span><span class=p>.</span><span class=nf>Unsubscribe</span><span class=p>(</span><span class=nx>resource</span><span class=p>,</span> <span class=nx>events</span><span class=p>)</span>
  <span class=k>for</span> <span class=p>{</span>
    <span class=k>select</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>e</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>events</span><span class=p>:</span>
      <span class=k>if</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Action</span> <span class=o>==</span> <span class=s>&#34;delete&#34;</span> <span class=o>||</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Store</span><span class=p>.</span><span class=nf>Authorize</span><span class=p>(</span><span class=nx>resource</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=s>&#34;read&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>Data</span><span class=p>)</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;event: %s\ndata: %s\n\n&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Action</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span>
        <span class=nx>flusher</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span>
      <span class=p>}</span>
    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>().</span><span class=nf>Done</span><span class=p>():</span>
      <span class=k>return</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>This SSE mechanism is trivial to use from JavaScript and many frameworks such as <a href=https://htmx.org>htmx</a> support it out the box to update view contents when an event arrives. This is how one can build a real-time chat or a microblog using Pennybase.</p><h2 id=hooks>Hooks</h2><p>Of course, built-in capabilities of Pennybase are questionable: validation is a joke, authNZ does not support relations between the resources, integrating it with other systems is impossible. Some BaaSes solve it by embedding a scripting language, such as JavaScript. Others add cloud functions. We choose hooks written in Go, so that one could import Pennybase as a module and use Go to extend its functionality.</p><p>Or, more precisely we only support one global hook function. It is invoked whenever a resource is about to be created, updated or deleted. Perhaps there is some use cases to invoke hooks on Get or List requests, but it&rsquo;s omitted for now.</p><p>A hook function can modify the resource, or perform additional validation as well as authorisation:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=nx>server</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>pennybase</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=s>&#34;data&#34;</span><span class=p>,</span> <span class=s>&#34;templates&#34;</span><span class=p>,</span> <span class=s>&#34;static&#34;</span><span class=p>)</span>
<span class=nx>server</span><span class=p>.</span><span class=nx>Hook</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>trigger</span><span class=p>,</span> <span class=nx>resource</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>user</span> <span class=nx>pennybase</span><span class=p>.</span><span class=nx>Resource</span><span class=p>,</span> <span class=nx>res</span> <span class=nx>pennybase</span><span class=p>.</span><span class=nx>Resource</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
  <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Hook triggered: %s on %s by user %v: %v&#34;</span><span class=p>,</span> <span class=nx>trigger</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span>
  <span class=k>if</span> <span class=nx>trigger</span> <span class=o>==</span> <span class=s>&#34;create&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>resource</span> <span class=o>==</span> <span class=s>&#34;messages&#34;</span> <span class=p>{</span>
    <span class=c1>// we can inject or modify resource fields based on relations between the resources
</span><span class=c1></span>    <span class=nx>r</span><span class=p>[</span><span class=s>&#34;author&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>user</span><span class=p>[</span><span class=s>&#34;_id&#34;</span><span class=p>]</span>
    <span class=nx>r</span><span class=p>[</span><span class=s>&#34;created_at&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>UTC</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=s>&#34;2006-01-02T15:04:05Z07:00&#34;</span><span class=p>)</span>
  <span class=p>}</span>
  <span class=c1>// we can also return an error if validation or authorisation fails
</span><span class=c1></span>  <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>Chaining hook functions like middleware is a way to keep them modular, but Pennybase leaves this as an exercise to the reader.</p><h2 id=conclusion>Conclusion</h2><p>Pennybase is a simple, yet powerful BaaS, that can be used to prototype web apps without building a separate backend each time. It has a simple data model, a simple storage, a REST API, authentication and authorization, real-time updates and &ldquo;admission hooks&rdquo;. Of course, it&rsquo;s still a toy, not a production level BaaS solution, but I hope it has some educational value and can be used as a conceptual starting point for some projects.</p><p>The final code with some examples can be found here: <a href=https://github.com/zserge/pennybase>https://github.com/zserge/pennybase</a></p><p>I hope youve enjoyed this article. You can follow  and contribute to  on <a href=https://github.com/zserge>Github</a>, <a href=https://mastodon.social/@zserge>Mastodon</a>, <a href=https://twitter.com/zsergo>Twitter</a> or subscribe via <a href=/rss.xml>rss</a>.</p><p class=date style=text-align:right><em>Jun 17, 2025</em></p><p>See also:
<a href=/posts/small-web/>Poor Man's Web</a> and <a href=/posts/>more</a>.</p></div><footer><p>&copy;2012&ndash;2024 &#183;
<a class=h-card rel=me href=https://zserge.com/>Serge Zaitsev</a> &#183;
<a href=mailto:hello@zserge.com rel=me>hello@zserge.com</a> &#183;
<a href=https://mastodon.social/@zserge rel=me>@zserge@mastodon.social</a></p></footer><script>new Image().src='https://nullitics.com/file.gif?u='+encodeURI(location.href)+'&r='+encodeURI(document.referrer)+'&d='+screen.width</script><noscript><img src=https://nullitics.com/file.gif></noscript></body></html>