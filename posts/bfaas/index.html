<!doctype html><html lang=en><head><meta charset=utf-8><title>Scalable, Resilient Brainf∗ck</title><meta name=description content="Building Brainf∗ck interpreter for the 21 century, with all the best systems design practices in mind. Think of Brainf∗ck-as-a-service cloud solution!"><meta name=author content="Serge Zaitsev"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=data:,><link rel="shortcut icon" sizes=32x32 href=/favicon.png><link rel="shortcut icon" sizes=192x192 href=/favicon-192x192.png><link rel=apple-touch-icon href=/favicon-192x192.png><link rel=alternate type=application/rss+xml title=RSS href=/rss.xml><link rel=canonical href=https://zserge.com/posts/bfaas/><meta property="og:title" content="Scalable, Resilient Brainf∗ck"><meta property="og:type" content="article"><meta property="og:url" content="https://zserge.com/posts/bfaas/"><meta property="og:image" content="https://zserge.com/logo.png"><meta property="og:description" content="Building Brainf∗ck interpreter for the 21 century, with all the best systems design practices in mind. Think of Brainf∗ck-as-a-service cloud solution!"><meta property="og:locale" content="en_US"><meta name=twitter:card content="Building Brainf∗ck interpreter for the 21 century, with all the best systems design practices in mind. Think of Brainf∗ck-as-a-service cloud solution!"><meta name=twitter:site content="@zsergo"><style type=text/css>body{padding:1rem;margin:auto;max-width:46rem;font-family:pt serif,Georgia,Cambria,times new roman,Times,serif;line-height:1.5;font-size:20px;color:rgba(0,0,0,.87);-webkit-font-smoothing:antialiased;font-weight:300}nav{display:flex;justify-content:space-between;align-items:center;margin:1em 0 3em}nav ul,nav li{display:inline-block;list-style:none;margin:0 0 0 .5rem;padding:0}nav ul{margin-right:1rem}.logo{background-color:rgba(0,0,0,.87);color:#fff;min-width:48px;min-height:48px;font-size:28px;border-radius:2px;display:flex;justify-content:center;align-items:center}.logo:hover{color:#fff}h1,h2{line-height:1.2;font-family:roboto,system-ui,segoe ui,Helvetica,Arial,sans-serif;font-weight:400;text-transform:uppercase;margin:1.34em 0 0}h1{font-size:1.95em}h2{font-size:1.25em;border-bottom:2px solid rgba(0,0,0,.87)}h1 a{color:rgba(0,0,0,.87)}p{margin:.67em 0 1em}a{color:#0076df;text-decoration:none;word-break:break-word}a:hover{color:rgba(0,0,0,.87)}ul,ol{list-style-position:outside;margin-left:1em}img{display:block;margin-left:auto;margin-right:auto;max-width:100%}pre,code{font-family:roboto mono,SFMono-Regular,Consolas,liberation mono,Menlo,monospace;font-weight:400;font-size:18px;color:rgba(0,0,0,.6);background:#eee}code{padding:.2rem .4rem;font-size:14px;border-radius:2px}pre{overflow-y:auto;line-height:20px;border-radius:2px;padding:1em}pre code{font-size:14px;padding:0;color:rgba(0,0,0,.87)}footer{font-size:12px}@media(prefers-color-scheme:dark){.logo{color:#444;background-color:#e4e4e4}.logo:hover{color:#444}body,h1 a,h2 a{background-color:#444;color:#e4e4e4}pre,pre code{background:#333;color:#e4e4e4}h2{border-bottom:1px solid #e4e4e4}code{color:#aaa;background:#333}a{color:#e39777}a:hover{color:#e4e4e4}img{filter:grayscale(30%)}}.hl{display:block;width:100%;background-color:#ffc}.ow,.gh,.gp,.gs,.gu,.nt,.nn,.ne,.ni,.nc,.kr,.kn,.kd,.kc,.k{font-weight:700}.c,.ch,.cm,.c1,.cs,.ge{color:#777}</style><link rel="shortcut icon" href=/favicon.ico></head><body><header><nav><a class=logo href=/>Z</a><ul><li><a href=/about/>about</a></li><li><a href=/posts/>posts</a></li><li><a href=https://twitter.com/zsergo rel=me>@me</a></li><li><a href=https://github.com/zserge rel=me>&lt;/>me</a></li></ul></nav></header><div id=content><h1>Scalable, Resilient Brainf∗ck</h1><p><em>You probably shouldn&rsquo;t read this article.</em></p><p>If you want to start learning a programming language - write a BF interpreter in it. For many years this has been a common suggestion to the newcomers into programming. And we all know how the typical solution would look like:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>s</span><span class=p>[</span><span class=mi>999</span><span class=p>],</span><span class=o>*</span><span class=n>r</span><span class=o>=</span><span class=n>s</span><span class=p>,</span><span class=o>*</span><span class=n>d</span><span class=p>,</span><span class=n>c</span><span class=p>;</span><span class=n>main</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>){</span><span class=kt>char</span><span class=o>*</span><span class=n>v</span><span class=o>=</span><span class=mi>1</span><span class=p>[</span><span class=n>d</span><span class=o>=</span><span class=n>b</span><span class=p>];</span><span class=k>for</span><span class=p>(;</span><span class=n>c</span><span class=o>=*</span><span class=n>v</span><span class=o>++%</span><span class=mi>93</span><span class=p>;)</span><span class=k>for</span><span class=p>(</span><span class=n>b</span><span class=o>=</span><span class=n>c</span><span class=o>%</span><span class=mi>7</span><span class=o>?</span><span class=n>a</span><span class=o>&amp;&amp;</span><span class=p>(</span><span class=n>c</span><span class=o>&amp;</span><span class=mi>17</span><span class=o>?</span><span class=n>c</span><span class=o>&amp;</span><span class=mi>1</span><span class=o>?</span>
<span class=p>(</span><span class=o>*</span><span class=n>r</span><span class=o>-=</span><span class=n>c</span><span class=o>-</span><span class=mi>44</span><span class=p>)</span><span class=o>:</span><span class=p>(</span><span class=n>r</span><span class=o>+=</span><span class=n>c</span><span class=o>-</span><span class=mi>61</span><span class=p>)</span><span class=o>:</span><span class=n>c</span><span class=o>&amp;</span><span class=mi>2</span><span class=o>?</span><span class=n>putchar</span><span class=p>(</span><span class=o>*</span><span class=n>r</span><span class=p>)</span><span class=o>:</span><span class=p>(</span><span class=o>*</span><span class=n>r</span><span class=o>=</span><span class=n>getchar</span><span class=p>()),</span><span class=mi>0</span><span class=p>)</span><span class=o>:</span><span class=n>v</span><span class=p>;</span><span class=n>b</span><span class=o>&amp;&amp;</span><span class=n>c</span><span class=o>|</span><span class=n>a</span><span class=o>**</span><span class=n>r</span><span class=p>;</span><span class=n>v</span><span class=o>=</span><span class=n>d</span><span class=p>)</span><span class=n>main</span><span class=p>(</span><span class=o>!</span><span class=n>c</span><span class=p>,</span><span class=o>&amp;</span>
<span class=n>b</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span><span class=n>d</span><span class=o>=</span><span class=n>v</span><span class=p>;}</span>
</code></pre></div><p>Well, or something a bit more readable in ~100 lines of code.</p><p>But, hey, that&rsquo;s not how things should be done these days! First of all, the common truth is that &ldquo;C is unsafe&rdquo; and thus should be avoided at all costs. We are writing an interpreter, a serious and complex software, so Java, Go, Python, at least Rust would be a good start.</p><p>Then, every junior programmer knows that computers are unreliable, and such a critical tool as interpreter should not be run on a local machine. Better move it into the cloud from the beginning. Nothing says &ldquo;I treat my software seriously&rdquo; better than paying for its CPU usage from your own pocket.</p><p>And of course, monoliths are so old-school. Look, BF interpreter has been waiting for years to be semantically split into self-contained microservices. How about we take one to do the parsing, another moves the pointer and the third one increments and decrements memory cells? Sounds logical, and definitely reduces the complexity of the interpreter.</p><p>When we do the parsing - we need to take care about the loops. Ideally, we should put loop beginning address onto the stack and pop it when we need to jump back and repeat the loop. However, nobody in their sane mind would be writing such complex data structure as stack manually! Fortunately, quick googling shows that Redis already has lists and stacks implemented, and it&rsquo;s a software with good reputation and many githib stars, so we&rsquo;d better delegate handling stacks to it. Some trivial LPUSH/LPOP commands would do all the job and our service remains small and focused.</p><p>Moving the pointer is not so simple either. Where do we store the pointer value? I suggest we take a MongoDB and put a pointer as a document there. Yes, for now it&rsquo;s just a single number, but who knows what else we would need to store in the future? We are lucky here, Mongo even has an <code>$inc</code> function to increment numbers, as if it was created to be used in BF interpreters! Talking to my SRE peers proves that if one has not got any weird problems with Mongo yet - they should definitely give it a try in production!</p><p>Finally, operations on memory cells. Whoa, this is hard. Memory is big and should be reliable. How about PostgreSQL? It&rsquo;s battle tested, we can set up a few replicas. In fact, let&rsquo;s go one step futher and think about performance. We can&rsquo;t put all memory cells into one database. That would be slow. How about we put odd addresses in one and even addresses in the other? Such sharding should speed up things a little.</p><p>Obviously, we need some kind of a load balancer at front. And, we are done!</p><p><img src=/images/bfaas.png alt=BF-a-a-S></p><p>You think I&rsquo;m joking? Here&rsquo;s a prototype - <a href=https://github.com/zserge/bfapi>https://github.com/zserge/bfapi</a> - and it works much like we&rsquo;ve designed above. Most of the code there was copied from StackOverflow, proving that it&rsquo;s correct and we can skip writing tests and save us some time. In fact, the service runs a &ldquo;hello world&rdquo; script in only 400ms! That&rsquo;s faster than a typical page loading on the web, proving that our design is a real improvement!</p><p>Enjoy, and please, think twice before adding complexity to the systems!</p><p>I hope you’ve enjoyed this article. You can follow – and contribute to – on <a href=https://github.com/zserge>Github</a>, <a href=https://twitter.com/zsergo>Twitter</a> or subscribe via <a href=/rss.xml>rss</a>.</p><p class=date style=text-align:right><em>Apr 01, 2021</em></p><p>See also:
<a href=/posts/better-c-benchmark/>A "Better C" Benchmark</a> and <a href=/posts/>more</a>.</p></div><footer><p>&copy;2012&ndash;2022 &#183;
<a class=h-card rel=me href=https://zserge.com/>Serge Zaitsev</a> &#183;
<a href=mailto:hello@zserge.com rel=me>hello@zserge.com</a></p></footer><script>(function(e,t,n,i,s,a,c){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)};a=t.createElement(i);c=t.getElementsByTagName(i)[0];a.async=true;a.src=s;c.parentNode.insertBefore(a,c)})(window,document,"galite","script","https://cdn.jsdelivr.net/npm/ga-lite@2/dist/ga-lite.min.js");galite('create','UA-33644825-1','auto');galite('send','pageview');</script><script>new Image().src='https://nullitics.com/file.gif?u='+encodeURI(location.href)+'&r='+encodeURI(document.referrer)+'&d='+screen.width</script><noscript><img src=https://nullitics.com/file.gif></noscript></body></html>