<!doctype html><html lang=en><head><meta charset=utf-8><title>Nokia Composer in 512 bytes</title><meta name=description content="Making a tiny oldschool music composer inspired by RTTTL and Nokia Composer"><meta name=author content="Serge Zaitsev"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=data:,><link rel="shortcut icon" sizes=32x32 href=/favicon.png><link rel="shortcut icon" sizes=192x192 href=/favicon-192x192.png><link rel=apple-touch-icon href=/favicon-192x192.png><link rel=alternate type=application/rss+xml title=RSS href=/rss.xml><link rel=canonical href=https://zserge.com/posts/nokia/><meta property="og:title" content="Nokia Composer in 512 bytes"><meta property="og:type" content="article"><meta property="og:url" content="https://zserge.com/posts/nokia/"><meta property="og:image" content="https://zserge.com/logo.png"><meta property="og:description" content="Making a tiny oldschool music composer inspired by RTTTL and Nokia Composer"><meta property="og:locale" content="en_US"><meta name=twitter:card content="Making a tiny oldschool music composer inspired by RTTTL and Nokia Composer"><meta name=twitter:site content="@zsergo"><style type=text/css>body{padding:1rem;margin:auto;max-width:46rem;font-family:pt serif,Georgia,Cambria,times new roman,Times,serif;line-height:1.5;font-size:20px;color:rgba(0,0,0,.87);-webkit-font-smoothing:antialiased;font-weight:300}nav{display:flex;justify-content:space-between;align-items:center;margin:1em 0 3em}nav ul,nav li{display:inline-block;list-style:none;margin:0 0 0 .5rem;padding:0}nav ul{margin-right:1rem}.logo{background-color:rgba(0,0,0,.87);color:#fff;min-width:48px;min-height:48px;font-size:28px;border-radius:2px;display:flex;justify-content:center;align-items:center}.logo:hover{color:#fff}h1,h2{line-height:1.2;font-family:roboto,system-ui,segoe ui,Helvetica,Arial,sans-serif;font-weight:400;text-transform:uppercase;margin:1.34em 0 0}h1{font-size:1.95em}h2{font-size:1.25em;border-bottom:2px solid rgba(0,0,0,.87)}h1 a{color:rgba(0,0,0,.87)}p{margin:.67em 0 1em}a{color:#0076df;text-decoration:none;word-break:break-word}a:hover{color:rgba(0,0,0,.87)}ul,ol{list-style-position:outside;margin-left:1em}img{display:block;margin-left:auto;margin-right:auto;max-width:100%}pre,code{font-family:roboto mono,SFMono-Regular,Consolas,liberation mono,Menlo,monospace;font-weight:400;font-size:18px;color:rgba(0,0,0,.6);background:#eee}code{padding:.2rem .4rem;font-size:14px;border-radius:2px}pre{overflow-y:auto;line-height:20px;border-radius:2px;padding:1em}pre code{font-size:14px;padding:0;color:rgba(0,0,0,.87)}footer{font-size:12px}@media(prefers-color-scheme:dark){.logo{color:#444;background-color:#e4e4e4}.logo:hover{color:#444}body,h1 a,h2 a{background-color:#444;color:#e4e4e4}pre,pre code{background:#333;color:#e4e4e4}h2{border-bottom:1px solid #e4e4e4}code{color:#aaa;background:#333}a{color:#e39777}a:hover{color:#e4e4e4}img{filter:grayscale(30%)}}.hl{display:block;width:100%;background-color:#ffc}.ow,.gh,.gp,.gs,.gu,.nt,.nn,.ne,.ni,.nc,.kr,.kn,.kd,.kc,.k{font-weight:700}.c,.ch,.cm,.c1,.cs,.ge{color:#777}</style><link rel="shortcut icon" href=/favicon.ico></head><body><header><nav><a class=logo href=/>Z</a><ul><li><a href=/about/>about</a></li><li><a href=/posts/>posts</a></li><li><a href=https://mastodon.social/@zserge rel=me>@me</a></li><li><a href=https://github.com/zserge rel=me>&lt;/>me</a></li></ul></nav></header><div id=content><h1>Nokia Composer in 512 bytes</h1><p>Those who ever owned an old Nokia phone like 3310 or 3210 might still remember its wonderful ability to compose your own ringtones straight on the phone&rsquo;s keyboard. By arranging notes and pauses you could end up with a popular tune beeped out of the phone&rsquo;s speaker, and furthermore, you could share it with your friends! If you missed that era, here&rsquo;s how it looked like:</p><p><img src=/images/nokia-composer.png alt=nokia-composer></p><p>Unimpressed? Well, trust me, it was really cool back then especially if you are into music.</p><p>The music notation and the format used in the Nokia Composer is known as <a href=https://en.wikipedia.org/wiki/Ring_Tone_Transfer_Language>RTTTL</a> (Ring Tone Text Transfer Language) and it is still widely used among the hobbyists to play monophonic tunes on Arduino and such.</p><p>RTTTL allows you to write music only for one &ldquo;voice&rdquo;, notes can only be played sequentially, with no chords or polyphony. This limitation is, however, the killer feature of the format, because it&rsquo;s easy to write, easy to read, easy to parse, and easy to play.</p><p>In this article, we will try to build an RTTTL player in JavaScript, with a bit of code-golfing and math hacks to make it as small as possible.</p><h2 id=parsing-rtttl>parsing rtttl</h2><p>There is a formal grammar for RTTTL - it consists of three parts: song name, song defaults like tempo (BPM), default octave, and default note duration. We will however mimic the behavior of the Nokia Composer itself and will only parse the melody part and treat BPM tempo as a separate input. The name of the song and the rest of the defaults will be left out of the scope.</p><p>The melody is just a sequence of notes/rests separated by commas with some optional whitespace. Each note consists of a duration (2/4/8/16/32/64), the note pitch (c/d/e/f/g/a/b), possibly a sharp sign (#), and an octave number (1-3 since only three octaves have been supported).</p><p>The simplest approach would be <a href=https://xkcd.com/208/>to use regexps</a>. New browsers come with a very convenient <code>matchAll</code> function that returns a collection of all matches within the string:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>play</span> <span class=o>=</span> <span class=nx>s</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=nx>m</span> <span class=k>of</span> <span class=nx>s</span><span class=p>.</span><span class=nx>matchAll</span><span class=p>(</span><span class=sr>/(\d*)?(\.?)(#?)([a-g-])(\d*)/g</span><span class=p>))</span> <span class=p>{</span>
    <span class=c1>// m[1] is optional note duration
</span><span class=c1></span>    <span class=c1>// m[2] is optional dot in note duration
</span><span class=c1></span>    <span class=c1>// m[3] is optional sharp sign, yes, it goes before the note
</span><span class=c1></span>    <span class=c1>// m[4] is note itself
</span><span class=c1></span>    <span class=c1>// m[5] is optional octave number
</span><span class=c1></span>  <span class=p>}</span>
<span class=p>};</span>
</code></pre></div><p>The first thing to figure out about each note is how to convert it into a frequency. Of course, we can make a hashmap for all possible seven letters of the notes, but since note letters are sequential - it should be simpler to treat them as numbers. For each note letter, we get a char code (ASCII code). For &lsquo;A&rsquo; that would be 0x41 and for &lsquo;a&rsquo; that would be 0x61. For &lsquo;B/b&rsquo; that would be 0x42/0x62, for &lsquo;C/c&rsquo; - 0x43/0x63 and so on:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// &#39;k&#39; is an ASCII code of the note:
</span><span class=c1>// A..G = 0x41..0x47
</span><span class=c1>// a..g = 0x61..0x67
</span><span class=c1></span><span class=kd>let</span> <span class=nx>k</span> <span class=o>=</span> <span class=nx>m</span><span class=p>[</span><span class=mi>4</span><span class=p>].</span><span class=nx>charCodeAt</span><span class=p>();</span>
</code></pre></div><p>We shall probably ignore the upper bits and only use <code>k&7</code> as the note index (a=1, c=2, &mldr;, g=7), but what&rsquo;s next?
The next part is unpleasantly tricky, and it&rsquo;s due to the music theory. If only we had 7 notes, yet, there are 12. And these sharp/flat notes are squeezed between the regular notes in a very uneven manner:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>         A#        C#    D#       F#    G#    A#         &lt;- black keys
      A     B | C     D     E  F     G     A     B | C   &lt;- white keys
      --------+------------------------------------+---
k&amp;7:  1     2 | 3     4     5  6     7     1     2 | 3
      --------+------------------------------------+---
note: 9 10 11 | 0  1  2  3  4  5  6  7  8  9 10 11 | 0
</code></pre></div><p>As we see here, the note index within the octave is increasing faster than the (k&7) note code. Also, it&rsquo;s increasing not linearly: the &ldquo;distance&rdquo; between E and F or between B and C is 1 semitone and not 2 like between the rest of the notes.</p><p>Intuitively, we may try multiplying (k&7) by 12/7 (there are 12 semitones and 7 notes):</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>note:          a     b     c     d     e      f     g
(k&amp;7)*12/7: 1.71  3.42  5.14  6.85  8.57  10.28  12.0
</code></pre></div><p>If we look at these numbers without the fractional components - we immediately notice they are already non-linear, much like we expected:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>note:                 a     b     c     d     e      f     g
(k&amp;7)*12/7:        1.71  3.42  5.14  6.85  8.57  10.28  12.0
floor((k&amp;7)*12/7):    1     3     5     6     8     10    12
                                  -------
</code></pre></div><p>..But not in the way we would expect - the &ldquo;semitone&rdquo; distance should be between B/C and E/F, not between C/D. Let&rsquo;s try other coefficients (the underlines indicate the semitones):</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>note:              a     b     c     d     e      f     g
floor((k&amp;7)*1.8):  1     3     5     7     9     10    12
                                           --------

floor((k&amp;7)*1.7):  1     3     5     6     8     10    11
                               -------           --------

floor((k&amp;7)*1.6):  1     3     4     6     8      9    11
                         -------           --------

floor((k&amp;7)*1.5):  1     3     4     6     7      9    10
                         -------     -------      -------
</code></pre></div><p>Clearly, the values of 1.8 and 1.5 do not fit - the first one has just one semitone and the last one has way too many. The other two, 1.6 and 1.7, are actually quite good: 1.7 results in a major scale of G-A-BC-D-EF and 1.6 results in a major scale of A-B-CD-E-F-G, which is exactly what we need!</p><p>Now we need to slightly adjust the values so that C would be 0, D would be 2, E would be 4, F would be 5, and so on. We should shift it by 4 semitones, but subtracting 4 would make A note lower than C note, so instead, we add 8 and calculate modulo 12 if the value overflows the octave:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=nx>n</span> <span class=o>=</span> <span class=p>(((</span><span class=nx>k</span><span class=o>&amp;</span><span class=mi>7</span><span class=p>)</span> <span class=o>*</span> <span class=mf>1.6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span> <span class=o>%</span> <span class=mi>12</span><span class=p>;</span>
<span class=c1>// A  B C D E F G A  B C ...
</span><span class=c1>// 9 11 0 2 4 5 7 9 11 0 ...
</span></code></pre></div><p>We should also take into consideration the sharp sign, which is captured by the m[3] regexp group. If it is present - we should increase the note value by 1 semitone:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// we use !!m[3], if m[3] is &#39;#&#39; - that would evaluate to `true`
</span><span class=c1>// and gets converted to `1` because of the `+` sign.
</span><span class=c1>// If m[3] is undefined - it turns into `false` and, thus, into `0`:
</span><span class=c1></span><span class=kd>let</span> <span class=nx>n</span> <span class=o>=</span> <span class=p>(((</span><span class=nx>k</span><span class=o>&amp;</span><span class=mi>7</span><span class=p>)</span> <span class=o>*</span> <span class=mf>1.6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span><span class=o>%</span><span class=mi>12</span> <span class=o>+</span> <span class=o>!!</span><span class=nx>m</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</code></pre></div><p>Finally, we should use the correct octave. Octaves are already stored as numbers in the m[5] regexp group, music theory tells us that each octave is 12 seminotes, so we can multiply octave number by 12 and add to the note value:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// n is a note index 0..35 where 0 is C of the lowest octave,
</span><span class=c1>// 12 is C of the middle octave and 35 is B of the highest octave.
</span><span class=c1></span><span class=kd>let</span> <span class=nx>n</span> <span class=o>=</span>
  <span class=p>(((</span><span class=nx>k</span><span class=o>&amp;</span><span class=mi>7</span><span class=p>)</span> <span class=o>*</span> <span class=mf>1.6</span><span class=p>)</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span><span class=o>%</span><span class=mi>12</span> <span class=o>+</span> <span class=c1>// note index 0..11
</span><span class=c1></span>  <span class=o>!!</span><span class=nx>m</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>+</span>                 <span class=c1>// semitote 0/1
</span><span class=c1></span>  <span class=nx>m</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>*</span> <span class=mi>12</span><span class=p>;</span>               <span class=c1>// octave number
</span></code></pre></div><h2 id=clamping>clamping</h2><p>What if someone writes 10 or 1000 as an octave number? That might result in an ultrasonic pitch. We should only allow the correct set of values for such parameters. Restricting a number between two other numbers is commonly known as &ldquo;clamping&rdquo;, and modern JS has a special function <code>Math.clamp(x, low, high)</code>, which, however, is not available in most browsers yet. The easiest alternative would be to use:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>clamp</span> <span class=o>=</span> <span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>b</span><span class=p>),</span> <span class=nx>a</span><span class=p>);</span>
</code></pre></div><p>But since we try to shorten our code as much as possible, we can re-invent the wheel and avoid using Math functions. We use <code>x=0</code> default value to make clamping work with <code>undefined</code> values as well:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>clamp</span> <span class=o>=</span> <span class=p>(</span><span class=nx>x</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>x</span> <span class=o>&lt;</span> <span class=nx>a</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>x</span> <span class=o>=</span> <span class=nx>a</span><span class=p>),</span> <span class=nx>x</span> <span class=o>&gt;</span> <span class=nx>b</span> <span class=o>?</span> <span class=nx>b</span> <span class=o>:</span> <span class=nx>x</span><span class=p>);</span>

<span class=nx>clamp</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span> <span class=c1>// =&gt; 1
</span><span class=c1></span><span class=nx>clamp</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span> <span class=c1>// =&gt; 2
</span><span class=c1></span><span class=nx>clamp</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span> <span class=c1>// =&gt; 3
</span><span class=c1></span><span class=nx>clamp</span><span class=p>(</span><span class=kc>undefined</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span> <span class=c1>// =&gt; 1
</span></code></pre></div><h3 id=tempo-and-note-durations>tempo and note durations</h3><p>We expect BPM to be passed as the parameter to out play() function, we only need to validate it:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>bpm = clamp(bpm, 40, 400);
</code></pre></div><p>Now, to calculate how long the note should last in seconds we can get its musical duration (whole/half/quarter/&mldr;), which is stored in m[1] regexp capture group, and use the following formula:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>note_duration</span> <span class=o>=</span> <span class=nx>m</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span> <span class=c1>// can be 1,2,4,8,16,32,64
</span><span class=c1>// since BPM is &#34;beats per minute&#34;, or usually &#34;quarter note beats per minute&#34;,
</span><span class=c1>// BPM/4 would be &#34;whole notes per minute&#34; and BPM/60/4 would be &#34;whole
</span><span class=c1>// notes per second&#34;:
</span><span class=c1></span><span class=nx>whole_notes_per_second</span> <span class=o>=</span> <span class=nx>bpm</span> <span class=o>/</span> <span class=mi>240</span><span class=p>;</span>
<span class=nx>duration</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=nx>whole_notes_per_second</span> <span class=o>*</span> <span class=nx>note_duration</span><span class=p>);</span>
</code></pre></div><p>If we minify these forumlas into one and clamp the note duration, we get:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// Assuming that default note duration is 4:
</span><span class=c1></span><span class=nx>duration</span> <span class=o>=</span> <span class=mi>240</span> <span class=o>/</span> <span class=nx>bpm</span> <span class=o>/</span> <span class=nx>clamp</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>||</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>64</span><span class=p>);</span>
</code></pre></div><p>It would be also nice to support dotted duration, which increases the current note length by 50%. We have a capture group <code>m[2]</code> whose value can be either a dot <code>.</code> or <code>undefined</code>. Applying the same trick we used for the sharp sign, we get:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// !!m[2] would be 1 if it&#39;s a dot, 0 otherwise
</span><span class=c1>// 1+!![m2]/2 would be 1 for normal notes and 1.5 for dotted notes
</span><span class=c1></span><span class=nx>duration</span> <span class=o>=</span> <span class=mi>240</span> <span class=o>/</span> <span class=nx>bpm</span> <span class=o>/</span> <span class=nx>clamp</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>||</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span><span class=o>+!!</span><span class=nx>m</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>/</span><span class=mi>2</span><span class=p>);</span>
</code></pre></div><p>Now we are able to calculate note numbers and durations for each note. Time to look into WebAudio API to actually play the tune.</p><h2 id=webaudio>WebAudio</h2><p>We only need 3 parts from the whole <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API>WebAudio API</a>: the audio context, the oscillator to procude the sound wave and the gain node to mute/unmute the sound. I will be using the square wave oscillator to make it sound much like the terrible buzzer of the old phones:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// Osc -&gt; Gain -&gt; AudioContext
</span><span class=c1></span><span class=kd>let</span> <span class=nx>audio</span> <span class=o>=</span> <span class=k>new</span> <span class=p>(</span><span class=nx>AudioContext</span><span class=p>()</span> <span class=o>||</span> <span class=nx>webkitAudioContext</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>gain</span> <span class=o>=</span> <span class=nx>audio</span><span class=p>.</span><span class=nx>createGain</span><span class=p>();</span>
<span class=kd>let</span> <span class=nx>osc</span> <span class=o>=</span> <span class=nx>audio</span><span class=p>.</span><span class=nx>createOscillator</span><span class=p>();</span>
<span class=nx>osc</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;square&#39;</span><span class=p>;</span>
<span class=nx>osc</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=nx>gain</span><span class=p>);</span>
<span class=nx>gain</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=nx>audio</span><span class=p>.</span><span class=nx>destination</span><span class=p>);</span>
<span class=nx>osc</span><span class=p>.</span><span class=nx>start</span><span class=p>();</span>
</code></pre></div><p>This code on its own does not produce any music yet, but as we parse our RTTTL melody - we can tell WebAudio which note to play, when, with what frequency, and for how long.</p><p>All WebAudio nodes have a special method <code>setValueAtTime</code>, which schedules an event to modify the value, such as frequency or gain level of the node.</p><p>If you recall from the previous parts of this article, we already had note ASCII code stored as <code>k</code>, note index as <code>n</code> and we had note <code>duration</code> in seconds. Now, for each note we can do the following:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>t</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// current time counter, in seconds
</span><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=nx>m</span> <span class=k>of</span> <span class=p>......)</span> <span class=p>{</span>
  <span class=c1>// ....we parse notes here...
</span><span class=c1></span>
  <span class=c1>// Note frequency is calculated as (F*2^(n/12)),
</span><span class=c1></span>  <span class=c1>// Where n is note index, and F is the frequency of n=0
</span><span class=c1></span>  <span class=c1>// We can use C2=65.41, or C3=130.81. C2 is a bit shorter.
</span><span class=c1></span>  <span class=nx>osc</span><span class=p>.</span><span class=nx>frequency</span><span class=p>.</span><span class=nx>setValueAtTime</span><span class=p>(</span><span class=mf>65.4</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>**</span> <span class=p>(</span><span class=nx>n</span> <span class=o>/</span> <span class=mi>12</span><span class=p>),</span> <span class=nx>t</span><span class=p>);</span>
  <span class=c1>// Turn on gain to 100%. Besides notes [a-g], `k` can also be a `-`,
</span><span class=c1></span>  <span class=c1>// which is a rest sign. `-` is 0x2d in ASCII. So, unlike other note letters,
</span><span class=c1></span>  <span class=c1>// (k&amp;8) would be 0 for notes and 8 for rest. If we invert `k`, then
</span><span class=c1></span>  <span class=c1>// (~k&amp;8) would be 8 for notes and 0 for rest. Shifing it by 3 would be
</span><span class=c1></span>  <span class=c1>// ((~k&amp;8)&gt;&gt;3) = 1 for notes and 0 for rests.
</span><span class=c1></span>  <span class=nx>gain</span><span class=p>.</span><span class=nx>gain</span><span class=p>.</span><span class=nx>setValueAtTime</span><span class=p>((</span><span class=o>~</span><span class=nx>k</span> <span class=o>&amp;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>3</span><span class=p>,</span> <span class=nx>t</span><span class=p>);</span>
  <span class=c1>// Increate the time marker by note duration
</span><span class=c1></span>  <span class=nx>t</span> <span class=o>=</span> <span class=nx>t</span> <span class=o>+</span> <span class=nx>duration</span><span class=p>;</span>
  <span class=c1>// Turn off the note
</span><span class=c1></span>  <span class=nx>gain</span><span class=p>.</span><span class=nx>gain</span><span class=p>.</span><span class=nx>setValueAtTime</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>t</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>That&rsquo;s all. Our play() routine can now play complete melodies, written in RTTTL notation. Here&rsquo;s the full code, with a few minifictions, such as using <code>v</code> as a shortcut for <code>setValueAtTime</code>, or using single-letter variables (C = context, z = oscillator because it buzzes, g = gain, q = bpm, c = clamp):</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>c</span> <span class=o>=</span> <span class=p>(</span><span class=nx>x</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span><span class=nx>a</span><span class=p>,</span><span class=nx>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>x</span><span class=o>&lt;</span><span class=nx>a</span><span class=o>&amp;&amp;</span><span class=p>(</span><span class=nx>x</span><span class=o>=</span><span class=nx>a</span><span class=p>),</span><span class=nx>x</span><span class=o>&gt;</span><span class=nx>b</span><span class=o>?</span><span class=nx>b</span><span class=o>:</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// clamping function (a&lt;=x&lt;=b)
</span><span class=c1></span><span class=nx>play</span> <span class=o>=</span> <span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>bpm</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>C</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AudioContext</span><span class=p>;</span>
  <span class=p>(</span><span class=nx>z</span> <span class=o>=</span> <span class=nx>C</span><span class=p>.</span><span class=nx>createOscillator</span><span class=p>()).</span><span class=nx>connect</span><span class=p>(</span><span class=nx>g</span> <span class=o>=</span> <span class=nx>C</span><span class=p>.</span><span class=nx>createGain</span><span class=p>()).</span><span class=nx>connect</span><span class=p>(</span><span class=nx>C</span><span class=p>.</span><span class=nx>destination</span><span class=p>);</span>
  <span class=nx>z</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;square&#39;</span><span class=p>;</span>
  <span class=nx>z</span><span class=p>.</span><span class=nx>start</span><span class=p>();</span>
  <span class=nx>t</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=nx>v</span> <span class=o>=</span> <span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=nx>v</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>x</span><span class=p>.</span><span class=nx>setValueAtTime</span><span class=p>(</span><span class=nx>v</span><span class=p>,</span> <span class=nx>t</span><span class=p>);</span> <span class=c1>// setValueAtTime shorter alias
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=nx>m</span> <span class=k>of</span> <span class=nx>s</span><span class=p>.</span><span class=nx>matchAll</span><span class=p>(</span><span class=sr>/(\d*)?(\.?)([a-g-])(#?)(\d*)/g</span><span class=p>))</span> <span class=p>{</span>
    <span class=nx>k</span> <span class=o>=</span> <span class=nx>m</span><span class=p>[</span><span class=mi>4</span><span class=p>].</span><span class=nx>charCodeAt</span><span class=p>();</span> <span class=c1>// note ASCII [0x41..0x47] or [0x61..0x67]
</span><span class=c1></span>    <span class=nx>n</span> <span class=o>=</span> <span class=mi>0</span><span class=o>|</span><span class=p>(((</span><span class=nx>k</span><span class=o>&amp;</span><span class=mi>7</span><span class=p>)</span> <span class=o>*</span> <span class=mf>1.6</span><span class=p>)</span><span class=o>+</span><span class=mi>8</span><span class=p>)</span><span class=o>%</span><span class=mi>12</span><span class=o>+!!</span><span class=nx>m</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=o>+</span><span class=mi>12</span><span class=o>*</span><span class=nx>c</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>);</span> <span class=c1>// note index [0..35]
</span><span class=c1></span>    <span class=nx>v</span><span class=p>(</span><span class=nx>z</span><span class=p>.</span><span class=nx>frequency</span><span class=p>,</span> <span class=mf>65.4</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>**</span> <span class=p>(</span><span class=nx>n</span> <span class=o>/</span> <span class=mi>12</span><span class=p>));</span>
    <span class=nx>v</span><span class=p>(</span><span class=nx>g</span><span class=p>.</span><span class=nx>gain</span><span class=p>,</span> <span class=p>(</span><span class=o>~</span><span class=nx>k</span> <span class=o>&amp;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>/</span> <span class=mi>8</span><span class=p>);</span>
    <span class=nx>t</span> <span class=o>=</span> <span class=nx>t</span> <span class=o>+</span> <span class=mi>240</span> <span class=o>/</span> <span class=nx>bpm</span> <span class=o>/</span> <span class=p>(</span><span class=nx>c</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>||</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>64</span><span class=p>))</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>+!!</span><span class=nx>m</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>/</span><span class=mi>2</span><span class=p>);</span>
    <span class=nx>v</span><span class=p>(</span><span class=nx>g</span><span class=p>.</span><span class=nx>gain</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>};</span>

<span class=c1>// Usage:
</span><span class=c1></span><span class=nx>play</span><span class=p>(</span><span class=s1>&#39;8c 8d 8e 8f 8g 8a 8b 8c2&#39;</span><span class=p>,</span> <span class=mi>120</span><span class=p>);</span>
</code></pre></div><p>When minified with <code>terser</code>, this code takes 417 bytes. This is still below the expected threshold of 512 bytes, so why don&rsquo;t we add a stop() function to interrupt the playback:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>C</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=c1>// initialize audio conteext C at the beginning with zero
</span><span class=c1></span><span class=nx>stop</span> <span class=o>=</span> <span class=nx>_</span> <span class=p>=&gt;</span> <span class=nx>C</span> <span class=o>&amp;&amp;</span> <span class=nx>C</span><span class=p>.</span><span class=nx>close</span><span class=p>(</span><span class=nx>C</span><span class=o>=</span><span class=mi>0</span><span class=p>);</span>
<span class=c1>// using `_` instead of `()` for zero-arg function saves us one byte :)
</span></code></pre></div><p>That&rsquo;s still about 445 bytes, and if you paste this code into your developer console - you would be able to play RTTTL and stop the playback by calling JS functions play() and stop().</p><h2 id=ui>UI</h2><p>However, I think adding some UI for the composer would improve the composing experience. At this point I would suggest forgetting about code golfing and make a tiny editor for the RTTTL melodies without saving any byte, using normal HTML and CSS, and including the minified script for playback only.</p><p>I wouldn&rsquo;t put the code here, it&rsquo;s pretty boring, instead, you may find it all on <a href=https://github.com/zserge/nokia-composer>github</a>. Also, you may try the live demo here: <a href=https://zserge.com/nokia-composer/>https://zserge.com/nokia-composer/</a></p><p><img src=/images/nokia-composer-demo.png alt=nokia-composer-demo></p><p>If your muse has left you for today and you are not into writing music today, feel free to try a few existing songs and enjoy the familiar beeping sound:</p><ul><li><a href="http://zserge.com/nokia-composer/#eyJicG0iOiIxMjAiLCJzb25nIjoiMTZlMiAxNmQyIDgjZiA4I2cgMTYjYzIgMTZiIDhkIDhlIDE2YiAxNmEgOCNjIDhlIDJhIDItIn0=">Nokia ringtone</a></li><li><a href=http://zserge.com/nokia-composer/#eyJicG0iOiIxMjAiLCJzb25nIjoiMTZjMiAxNiNhIDhnIDhjMiA4ZiA4YzIgOCNhIDhjMiA4ZiA0Li0gOGcgOC0gOGcgOCNhIDE2LmMyIDMyLSAxNmMyIDE2I2EgOGcgOGMyIDhmIDhjMiA4I2EgOGMyIDhmIDQuLSA4ZyA4LSA4ZyA4I2EgMTYuYzIgMzItIDE2YzIgMTYjYSA4ZyA4YzIgOGYgOGMyIDgjYSA4YzIgOGYgNC4tIDhnIDgtIDhnIDgjYSAxNi5jMiAzMi0gMTZjMiAxNiNhIDhnIDhjMiA4ZiA4YzIgOCNhIDhjMiA4ZiJ9>iPhone ringtone, if you are more into contemporary music</a></li><li><a href="http://zserge.com/nokia-composer/#eyJicG0iOiIxMjAiLCJzb25nIjoiOGIyIDE2ZzIgMTZhMiA4YjIgOGQzIDhjMyA4YjIgOGEyIDhnMiA4YTIgMTZmMiAxNmEyIDhjMyA4ZjMgMTZkMyAxNmMzIDE2I2EyIDE2ZzIgOCNnMiA4ZzIgOCNnMiAxNmcyIDE2YTIgOGIyIDgjYzMgMTZiMiAxNmEyIDE2ZzIgMTZmMiA4ZTIgOGYyIDFhMiA0YTIifQ==">Light My Fire</a></li><li><a href="http://zserge.com/nokia-composer/#eyJicG0iOiIyNTAiLCJzb25nIjoiNGEyIDgtIDhkMSA0LSA4ZDEgNC0gOGQxIDQtIDhkMSA0LSA4ZDEgNC0gOGQxIDQtIDhkMSA0LSA0ZjIgOC0gOGQxIDQtIDhkMSA0LSA4ZDEgNC0gNGcyIDgtIDhkMSA0LSA0YzMgOCNhMiA0YTIgOGcyIDRhMiA4LSA4ZDEgNC0gOGQxIDQtIDhkMSA0LSA4ZDEgNC0gOGQxIDQtIDhkMSA0LSA4ZDEgNC0gNGYyIDgtIDhkMSA0LSA4ZDEgNC0gOGQxIDQtIDRnMiA4LSA4ZDEgNC0gNGMzIDgjYTIgNGEyIDhnMiA0YTIifQ==">Lose Yourself</a></li><li><a href="http://zserge.com/nokia-composer/#eyJicG0iOiI2MyIsInNvbmciOiIzMmMyIDMyZjIgMzJjMiAzMmYyIDRjMiA4I2cxIDgjYTEgNGYxIDgtXG4zMmMyIDMyZjIgMzJjMiAzMmYyIDRjMiA4I2cxIDgjYTEgNCNkMiA4LVxuMTZjMiAxNiNkMiA0ZjIgOCNnMiAxNmcyIDE2ZjIgNCNkMiA4LVxuMzJjMiAzMmYyIDMyYzIgMzJmMiA0YzIgOCNhMSA0ZjEifQ==">The Good, The Bad, and The Ugly</a></li><li><a href="http://zserge.com/nokia-composer/#eyJicG0iOiIxODAiLCJzb25nIjoiMTYjZjEgMTZlMSAxNiNkMSAxNmUxIDRnMSAxNmExIDE2ZzEgMTYjZjEgMTZnMSA0YjEgMTZjMiAxNmIxIDE2I2ExIDE2YjEgMTYjZjIgMTZlMiAxNiNkMiAxNmUyIDE2I2YyIDE2ZTIgMTYjZDIgMTZlMiA0ZzIgOGUyIDhnMiAzMmQyIDMyZTIgMTYjZjIgOGUyIDhkMiA4ZTIgMzJkMiAzMmUyIDE2I2YyIDhlMiA4ZDIgOGUyIDMyZDIgMzJlMiAxNiNmMiA4ZTIgOGQyIDgjYzIgNGIxIn0=">Rondo Alla Turca (Mozart)</a></li></ul><p>Enjoy! Ah, by the way, if you actually composed something there - please share the URL (the whole song and the BPM are stored in the hash part of the URL, so saving/sharing your songs is as simple as copying or bookmarking the link.</p><p>I hope you’ve enjoyed this article. You can follow – and contribute to – on <a href=https://github.com/zserge>Github</a>, <a href=https://mastodon.social/@zserge>Mastodon</a>, <a href=https://twitter.com/zsergo>Twitter</a> or subscribe via <a href=/rss.xml>rss</a>.</p><p class=date style=text-align:right><em>Oct 13, 2020</em></p><p>See also:
<a href=/posts/tiny-font/>Making a tiny 2x3 bitmap font</a> and <a href=/posts/>more</a>.</p></div><footer><p>&copy;2012&ndash;2025 &#183;
<a class=h-card rel=me href=https://zserge.com/>Serge Zaitsev</a> &#183;
<a href=mailto:hello@zserge.com rel=me>hello@zserge.com</a> &#183;
<a href=https://mastodon.social/@zserge rel=me>@zserge@mastodon.social</a></p></footer><script>new Image().src='https://nullitics.com/file.gif?u='+encodeURI(location.href)+'&r='+encodeURI(document.referrer)+'&d='+screen.width</script><noscript><img src=https://nullitics.com/file.gif></noscript></body></html>