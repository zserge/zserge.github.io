<!doctype html><html lang=en><head><meta charset=utf-8><title>Emulating 6502</title><meta name=description content="My journey into retrocomputing, 8-bit home computers, Apple I and of course MOS 6502 assembly."><meta name=author content="Serge Zaitsev"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=data:,><link rel="shortcut icon" sizes=32x32 href=/favicon.png><link rel="shortcut icon" sizes=192x192 href=/favicon-192x192.png><link rel=apple-touch-icon href=/favicon-192x192.png><link rel=alternate type=application/rss+xml title=RSS href=/rss.xml><link rel=canonical href=https://zserge.com/posts/6502/><meta property="og:title" content="Emulating 6502"><meta property="og:type" content="article"><meta property="og:url" content="https://zserge.com/posts/6502/"><meta property="og:image" content="https://zserge.com/logo.png"><meta property="og:description" content="My journey into retrocomputing, 8-bit home computers, Apple I and of course MOS 6502 assembly."><meta property="og:locale" content="en_US"><meta name=twitter:card content="My journey into retrocomputing, 8-bit home computers, Apple I and of course MOS 6502 assembly."><meta name=twitter:site content="@zsergo"><style type=text/css>body{padding:1rem;margin:auto;max-width:46rem;font-family:pt serif,Georgia,Cambria,times new roman,Times,serif;line-height:1.5;font-size:20px;color:rgba(0,0,0,.87);-webkit-font-smoothing:antialiased;font-weight:300}nav{display:flex;justify-content:space-between;align-items:center;margin:1em 0 3em}nav ul,nav li{display:inline-block;list-style:none;margin:0 0 0 .5rem;padding:0}nav ul{margin-right:1rem}.logo{background-color:rgba(0,0,0,.87);color:#fff;min-width:48px;min-height:48px;font-size:28px;border-radius:2px;display:flex;justify-content:center;align-items:center}.logo:hover{color:#fff}h1,h2{line-height:1.2;font-family:roboto,system-ui,segoe ui,Helvetica,Arial,sans-serif;font-weight:400;text-transform:uppercase;margin:1.34em 0 0}h1{font-size:1.95em}h2{font-size:1.25em;border-bottom:2px solid rgba(0,0,0,.87)}h1 a{color:rgba(0,0,0,.87)}p{margin:.67em 0 1em}a{color:#0076df;text-decoration:none;word-break:break-word}a:hover{color:rgba(0,0,0,.87)}ul,ol{list-style-position:outside;margin-left:1em}img{display:block;margin-left:auto;margin-right:auto;max-width:100%}pre,code{font-family:roboto mono,SFMono-Regular,Consolas,liberation mono,Menlo,monospace;font-weight:400;font-size:18px;color:rgba(0,0,0,.6);background:#eee}code{padding:.2rem .4rem;font-size:14px;border-radius:2px}pre{overflow-y:auto;line-height:20px;border-radius:2px;padding:1em}pre code{font-size:14px;padding:0;color:rgba(0,0,0,.87)}footer{font-size:12px}@media(prefers-color-scheme:dark){.logo{color:#444;background-color:#e4e4e4}.logo:hover{color:#444}body,h1 a,h2 a{background-color:#444;color:#e4e4e4}pre,pre code{background:#333;color:#e4e4e4}h2{border-bottom:1px solid #e4e4e4}code{color:#aaa;background:#333}a{color:#e39777}a:hover{color:#e4e4e4}img{filter:grayscale(30%)}}.hl{display:block;width:100%;background-color:#ffc}.ow,.gh,.gp,.gs,.gu,.nt,.nn,.ne,.ni,.nc,.kr,.kn,.kd,.kc,.k{font-weight:700}.c,.ch,.cm,.c1,.cs,.ge{color:#777}</style><link rel="shortcut icon" href=/favicon.ico></head><body><header><nav><a class=logo href=/>Z</a><ul><li><a href=/about/>about</a></li><li><a href=/posts/>posts</a></li><li><a href=https://mastodon.social/@zserge rel=me>@me</a></li><li><a href=https://github.com/zserge rel=me>&lt;/>me</a></li></ul></nav></header><div id=content><h1>Emulating 6502</h1><p>Last year, I noticed that routine programming no longer brought me the same joy it did decades ago. So, my New Year&rsquo;s resolution was to engage in more &ldquo;useless&rdquo; programming &ndash; coding small, fun projects without any specific end goal in mind. Of all the possible topics, the one that captivated me throughout the year was retrocomputing.</p><p>I didn’t have a computer until I was 14, but I remember seeing grey 8-bit machines at school or friends' houses. I saw BASIC and played blocky games on monochrome TVs. So, I felt the need to revisit those times and learn more about how things worked back then.</p><p>Over the year I visited some retrocomputing festivals and museums, built a plywood arcade cabinet with a kid, and worked with a friend to design a small handheld monochrome gaming console, complete with schematics, PCB, and firmware!</p><p>But for me, the retrocomputing journey began with the MOS 6502.</p><h2 id=6502>6502</h2><p>MOS6502 is a brilliant little CPU that every geek should try emulating or programming. It&rsquo;s at the core of nearly every 8-bit retro computer: Atari 2600, Apple I, Apple II, NES, Commodore 64, VIC-20, Atari Lynx, BBC Micro &ndash; the list is endless.</p><p>6502 features a simple yet powerful instruction set. With only 56 opcodes, it wouldn&rsquo;t take more than a day to implement all of them.</p><p>In this article, we’ll emulate MOS 6502 in Python to run Apple I ROMs. But first, let’s explore a few core concepts.</p><p>MOS6502 has just three general-purpose registers: A (accumulator), X, and Y (index registers). Additionally, there&rsquo;s a flag register (F), a stack register (S), and a program counter (PC). The CPU supports 16-bit memory addresses, meaning it can handle up to 64KB of RAM. To exceed this limit, you’d need to use bank switching, dynamically swapping memory regions to map the same 16-bit address to different memory regions.</p><p>The 6502’s memory layout is somewhat unusual by modern standards:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>┌───────────┐         
│ IRQ addr  │ 0xffff  
│ RST addr  │ 0xfffd  
│ NMI addr  │ 0xfffb  
├───────────┤         
│ ROM code  │         
├───────────┤         
│ I/O regs  │ 0xd000  
├───────────┤         
│ Free RAM  │         
├───────────┤         
│ Stack     │ 0x0100  
├───────────┤         
│ Zero Page │ 0x0000  
└───────────┘         
</code></pre></div><p>Interrupt vectors are located at the end of the address space. These vectors point to the reset (RST) handler, IRQ handler, and non-maskable interrupt (NMI) handler. Each handler address is two bytes long. The RST handler is where the &ldquo;OS&rdquo; code begins execution. IRQ and NMI are used to handle hardware interactions; the difference is that IRQ can be programmatically disabled (masked), while NMI cannot.</p><p>The rest of the address space varies between computers, but generally includes ROM (or EEPROM), which stores the &ldquo;monitor&rdquo; program or OS BASIC interpreter code. There are also memory-mapped I/O areas for peripherals like timers, keyboards, displays, cassette readers etc. Each byte in these areas has a specific purpose, with reads and writes triggering hardware actions.</p><p>Finally, there’s RAM. Most 8-bit computers of the time had 1KB to 16KB of RAM. Of this, the first 256 bytes (known as the “zero page”) and the next 256 bytes (reserved for the CPU stack) had special purposes.</p><p>With this understanding, we’re ready to start writing our emulator. First, we’ll need helpers to handle 16-bit unsigned integers and convert between types. The 6502 CPU operates on a memory bus, which we&rsquo;ll implement as a list-like object supporting <code>__setitem__</code> and <code>__getitem__</code> for accessing individual bytes at specific addresses. This bus will handle memory-mapped I/O, interrupt vectors, ROM, and RAM, appearing as “memory” from the CPU&rsquo;s perspective.</p><p>Next, we’ll write helpers for memory operations: reading single or double bytes, pushing and popping values to/from the stack. MOS6502 is little-endian, and since the stack grows by decrementing the pointer, higher bytes must be pushed first.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=c1># General helpers for u8 and u16 data types</span>
<span class=k>def</span> <span class=nf>u16</span><span class=p>(</span><span class=n>n</span><span class=p>):</span> <span class=k>return</span> <span class=n>n</span> <span class=o>&amp;</span> <span class=mh>0xFFFF</span>
<span class=k>def</span> <span class=nf>u8</span><span class=p>(</span><span class=n>n</span><span class=p>):</span> <span class=k>return</span> <span class=n>n</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
<span class=k>def</span> <span class=nf>to16</span><span class=p>(</span><span class=n>lo</span><span class=p>,</span> <span class=n>hi</span><span class=p>):</span> <span class=k>return</span> <span class=n>lo</span> <span class=o>+</span> <span class=n>hi</span> <span class=o>*</span> <span class=mh>0x100</span>

<span class=k>class</span> <span class=nc>MOS6502</span><span class=p>:</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bus</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>bus</span> <span class=o>=</span> <span class=n>bus</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>s</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>pc</span> <span class=o>=</span> <span class=mh>0xFD</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=n>to16</span><span class=p>(</span><span class=n>bus</span><span class=p>[</span><span class=mh>0xFFFC</span><span class=p>],</span> <span class=n>bus</span><span class=p>[</span><span class=mh>0xFFFD</span><span class=p>])</span>
    <span class=k>def</span> <span class=nf>fetch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>offset</span><span class=p>):</span> <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=p>[</span><span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pc</span> <span class=o>+</span> <span class=n>offset</span><span class=p>)]</span>
    <span class=k>def</span> <span class=nf>fetch16</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>offset</span><span class=p>):</span> <span class=k>return</span> <span class=n>to16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=n>offset</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=n>u16</span><span class=p>(</span><span class=n>offset</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)))</span>
    <span class=k>def</span> <span class=nf>push</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span> <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>s</span> <span class=o>|</span> <span class=mh>0x100</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span><span class=p>;</span> <span class=bp>self</span><span class=o>.</span><span class=n>s</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>pop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span> <span class=bp>self</span><span class=o>.</span><span class=n>s</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span> <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>s</span> <span class=o>|</span> <span class=mh>0x100</span><span class=p>]</span>
    <span class=k>def</span> <span class=nf>push16</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span> <span class=bp>self</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=n>value</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>));</span> <span class=bp>self</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
    <span class=k>def</span> <span class=nf>pop16</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span> <span class=k>return</span> <span class=n>to16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pop</span><span class=p>(),</span> <span class=bp>self</span><span class=o>.</span><span class=n>pop</span><span class=p>())</span>
</code></pre></div><h2 id=addressing-modes>Addressing Modes</h2><p>One of the most unusual aspects of the 6502 is its addressing modes, which dictate how the CPU fetches operands for each instruction.</p><ul><li>Implicit Mode: No operand is specified, as it’s implied by the instruction itself (e.g., NOP takes no operand, and CLC clears a status flag without a need for an operand, too).</li><li>Immediate Mode: The operand is included directly in the instruction bytes.</li><li>Absolute Mode: The instruction specifies the memory address of the operand as a 16-bit value.</li><li>Relative Mode: The operand&rsquo;s address is relative to the current PC, using a 1-byte signed offset (-128 to +127). This is typically used for branching.</li><li>Indirect Mode: The instruction specifies an address containing the final address to jump to. Think of dereferencing a pointer to the address.</li><li>Zero-page addressing modes are what makes 6502 unique. They restrict the addressable memory to the first 256 bytes but use various combinations of X, Y, and indirect addressing for flexibility.</li><li>Indexed Modes: These use the X/Y registers to calculate the final address, either as an offset to an absolute address or within the zero page.</li></ul><p>It may sound confusing, but it&rsquo;s not, and here&rsquo;s some short code to prove it. It implements all of the 6502 addressing modes:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>zp16</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>):</span> <span class=k>return</span> <span class=n>to16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=p>[</span><span class=n>addr</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=p>[</span><span class=n>u16</span><span class=p>(</span><span class=n>addr</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)])</span>

<span class=k>def</span> <span class=nf>addr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mode</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>ABS</span><span class=p>:</span> <span class=k>return</span> <span class=n>to16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>ABX</span><span class=p>:</span> <span class=k>return</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>addr</span><span class=p>(</span><span class=n>ABS</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span> 
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>ABY</span><span class=p>:</span> <span class=k>return</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>addr</span><span class=p>(</span><span class=n>ABS</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span> 
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>IMM</span><span class=p>:</span> <span class=k>return</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pc</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>IZX</span><span class=p>:</span> <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>zp16</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>))</span>
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>IZY</span><span class=p>:</span> <span class=k>return</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>zp16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>REL</span><span class=p>:</span> <span class=k>return</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=mh>0x80</span><span class=p>)</span> <span class=o>-</span> <span class=mh>0x80</span>
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>ZPG</span><span class=p>:</span> <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>ZPX</span><span class=p>:</span> <span class=k>return</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>ZPY</span><span class=p>:</span> <span class=k>return</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>
    <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=n>IND</span><span class=p>:</span>
        <span class=n>addr</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch16</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>to16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=p>[</span><span class=n>addr</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>bus</span><span class=p>[(</span><span class=n>addr</span> <span class=o>&amp;</span> <span class=mh>0xff00</span><span class=p>)</span> <span class=o>|</span> <span class=n>u8</span><span class=p>(</span><span class=n>addr</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)])</span>
</code></pre></div><p>There is an additional &ldquo;accumulator&rdquo; mode not listed here. It means the operand is not in memory, but in the <code>A</code> register (which has no &ldquo;address&rdquo;, so we treat it differently when reading/writing bytes):</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>def read(self, mode): return self.a if mode == ACC else self.bus[self.addr(mode)]
def write(self, mode, value):
    if mode == ACC: self.a = value
    else: self.bus[self.addr(mode)] = value
</code></pre></div><h2 id=instructions>Instructions</h2><p>6502 has the following instruction groups:</p><ul><li>Load/Store (LDA, LDX, LDY, STA, STX, STY) - &ldquo;mov&rdquo; for registers and memory.</li><li>Transfer (TAX, TAY, TXA, TYA) - &ldquo;mov&rdquo; for A and X/Y.</li><li>Stack (TSX, TXS, PHA, PHP, PLA, PLP) - &ldquo;push&rdquo; and &ldquo;pop&rdquo;, or &ldquo;mov&rdquo; for S/X</li><li>Arithmetic (ADC, SBC, CMP, CPX, CPY) - add/sub and compare</li><li>Bitwise (AND, EOR, ORA, BIT) - bitwise operations</li><li>Shifts (ASL, LSR, ROL, ROR) - shift and rotate bits</li><li>Increments (INC, INX, INY, DEC, DEX, DEY) - inc/dec</li><li>Jumps (JMP, JSR, RTS, RTI) - jmp/ret</li><li>Branches (BCC, BCS, BEQ, BMI, BNE, BPL, BVC, BVS) - jump if condition</li><li>Status flag (CLC, CLD, CLI, CLV, SEC, SED, SEI) - set and clear flags</li><li>Misc (BKR, NOP) - break and nop</li></ul><p>Not too many, and each of the is encoded as an individual byte value followed by operands. The mode is determined by the instruction byte, i.e. <code>LDA</code> can be encoded as 8 different byte values, depending on the operand mode.</p><p>Each instruction takes 0-3 bytes for its operands. To handle this, we&rsquo;ll use a lookup table to determine the instruction length and increment the PC accordingly:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>OPSZ</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</code></pre></div><p>We&rsquo;ll now write the core of our emulator, which fetches and executes instructions step by step:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>step</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
    <span class=n>op</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>next_pc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pc</span> <span class=o>+</span> <span class=n>OPSZ</span><span class=p>[</span><span class=n>op</span><span class=p>]</span>
    <span class=k>if</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x00</span><span class=p>:</span> <span class=k>pass</span>   <span class=c1># BRK,IMP,1,7,cziDBvn</span>
    <span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x20</span><span class=p>:</span> <span class=k>pass</span> <span class=c1># JSR,ABS,3,6,czidbvn</span>
    <span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x69</span><span class=p>:</span> <span class=k>pass</span> <span class=c1># ADC,IMM,2,2,CZidbVN</span>
    <span class=c1># TODO: implement every instruction here</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>pc</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=n>next_pc</span><span class=p>)</span>
</code></pre></div><p>We fetch instruction&rsquo;s first byte and prepare to advance <code>PC</code>. Then we&rsquo;ll have a giant if/else block for all the supported opcodes (151 of them). In the comments for each opcode I describe instruction name, addressing mode, number of bytes, number of CPU cycles and the CPU flags that it may affect.</p><p>But before we start implementing all the instructions, let&rsquo;s implement a proper memory bus from a real computer.</p><h2 id=apple-i>Apple I</h2><p>To test our emulator, we&rsquo;ll use the Apple I computer, Apple&rsquo;s first product from 1976. It featured 4KB or 8KB of RAM and a monitor program (WozMon) packed into just 256 bytes of machine code. Apple I supported Integer BASIC, a 40×24 text terminal, and cassette data storage. Not much, and it only sold 200 units, but it&rsquo;s still a remarkable piece of engineering.</p><p>Memory-mapped I/O for Apple I includes:</p><ul><li>0xD010: code of the pressed key, or 0x80 if no key is pressed.</li><li>0xD011: 0x80 if a key is pressed; 0 otherwise.</li><li>0xD012: Writes to this address are displayed on the screen.</li></ul><p>We’ll load the WozMon binary into ROM at 0xFF00–0xFFFF:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>import base64
WOZMON = base64.b64decode(&#39;2Figf4wS0KmnjRHQjRPQyd/wE8mb8APIEA+p3CDv/6mNIO//oAGIMPatEdAQ+60Q0JkAAiDv/8mN0NSg/6kAqgqFK8i5AALJjfDUya6Q9PDwybrw68nS8DuGKIYphCq5AAJJsMkKkAZpiMn6kBEKCgoKogQKJigmKcrQ+MjQ4MQq8JckK1AQpSiBJuYm0LXmJ0xE/2wkADArogK1J5UllSPK0PfQFKmNIO//pSUg3P+lJCDc/6m6IO//qaAg7/+hJCDc/4YrpSTFKKUl5SmwweYk0ALmJaUkKQcQyEhKSkpKIOX/aCkPCbDJupACaQYsEtAw+40S0GAAAAAPAP8AAA==&#39;)

class AppleI:
  def __init__(self):
    self.keys = []
    self.mem = bytearray(0x2000)
    self.wozmon = WOZMON
  def __getitem__(self, i):
    if i &gt;= 0 and i &lt;= 0x2000: return self.mem[i] # 8K RAM
    elif i &gt;= 0xff00 and i &lt;= 0xffff: return self.wozmon[i - 0xff00]
    elif i == 0xd010: return self.keys.pop(0)|0x80 if len(self.keys) else 0x80
    elif i == 0xd011: return 0x80 if len(self.keys) else 0
    else: return 0
  def __setitem__(self, i, n):
    if i &gt;= 0 and i &lt; 0x0fff: self.mem[i] = n
    elif i == 0xd012:
      if n &amp; 0x7f == 0x0d: print(&#39;&#39;)
      elif n &amp; 0x7f == 0x5f: print(&#39;\b&#39;, end = &#39;&#39;, flush=True)
      else: print(chr(n&amp;0x7f), end=&#39;&#39;, flush=True)
  def send_key(self, c):
    self.keys.append(c)

a1 = AppleI()
a1[0xd012] = 65; # &#39;A&#39;
a1[0xd012] = 49; # &#39;1&#39;
a1[0xd012] = 13; # &#39;\r&#39;
for i in range(256): print(f&#34;{a1[0xff00+i]:x}&#34;, end=&#39; &#39;)
</code></pre></div><p>Sending 3 bytes to the bus should print &ldquo;A1&rdquo; (note that Apple used <code>CR=13</code> instead of <code>NL=10</code>).</p><p>Then we display machine codes of the WozMon:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>d8 58 a0 7f 8c 12 d0 a9 a7 8d 11 d0 8d 13 d0 c9 df f0 13 c9 9b f0 03 c8 10 0f a9 dc 20 ef ff a9 8d 20 ef ff a0 01 88 30 f6 ad 11 d0 10 fb ad 10 d0 99 00 02 20 ef ff c9 8d d0 d4 a0 ff a9 00 aa 0a 85 2b c8 b9 00 02 c9 8d f0 d4 c9 ae 90 f4 f0 f0 c9 ba f0 eb c9 d2 f0 3b 86 28 86 29 84 2a b9 00 02 49 b0 c9 0a 90 06 69 88 c9 fa 90 11 0a 0a 0a 0a a2 04 0a 26 28 26 29 ca d0 f8 c8 d0 e0 c4 2a f0 97 24 2b 50 10 a5 28 81 26 e6 26 d0 b5 e6 27 4c 44 ff 6c 24 00 30 2b a2 02 b5 27 95 25 95 23 ca d0 f7 d0 14 a9 8d 20 ef ff a5 25 20 dc ff a5 24 20 dc ff a9 ba 20 ef ff a9 a0 20 ef ff a1 24 20 dc ff 86 2b a5 24 c5 28 a5 25 e5 29 b0 c1 e6 24 d0 02 e6 25 a5 24 29 07 10 c8 48 4a 4a 4a 4a 20 e5 ff 68 29 0f 09 b0 c9 ba 90 02 69 06 2c 12 d0 30 fb 8d 12 d0 60 00 00 00 0f 00 ff 00 00
</code></pre></div><p>The emulator begins execution at the reset vector (0xFFFC), starting with the CLD (0xd8) and CLI (0x58) instructions. Both operate on flags.</p><h2 id=flags>Flags</h2><p>The flag register is an 8-bit register where only seven bits are utilized (<code>NV1BDIZC</code>).</p><ul><li>N (Negative): Mirrors the top bit of the result after an arithmetic operation.</li><li>V (Overflow): Set during ADC/SBC if overflow occurs.</li><li>1: Reserved and typically set to 1.</li><li>B (Break): Differentiates hardware (IRQ/NMI) from software (BRK) interrupts.</li><li>D (Decimal): Enables BCD mode for arithmetic operations.</li><li>I (Interrupt): Disables interrupts (IRQ).</li><li>Z (Zero): Indicates if the result is zero.</li><li>C (Carry): Acts as a 9th bit for addition/subtraction and bit shifts.</li></ul><p>Instructions to set/clear individual flags use implicit addressing and require no arguments, simplifying implementation:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x18</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xFE</span>  <span class=c1># CLC,IMP,1,2,Czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xD8</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xF7</span>  <span class=c1># CLD,IMP,1,2,cziDbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x58</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xFB</span>  <span class=c1># CLI,IMP,1,2,czIdbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xB8</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xBF</span>  <span class=c1># CLV,IMP,1,2,czidbVn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x38</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>|</span> <span class=mh>0x01</span>  <span class=c1># SEC,IMP,1,2,Czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xF8</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>|</span> <span class=mh>0x08</span>  <span class=c1># SED,IMP,1,2,cziDbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x78</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>|</span> <span class=mh>0x04</span>  <span class=c1># SEI,IMP,1,2,czIdbvn</span>
</code></pre></div><p>We can also add a helper to set N/Z flags, depending on the result:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>nz</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x7D</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=nb>int</span><span class=p>(</span><span class=n>x</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>x</span>
</code></pre></div><p>Here we set <code>N</code> if the 8th bit of the result is set. We set <code>Z</code> bit if the result is zero.</p><p>There is one instruction left in this family, <code>BIT</code>. It fetches a memory byte and updates the flags:</p><ul><li><code>N</code> mirrors the memory byte&rsquo;s 8th bit</li><li><code>V</code> mirrors the memory byte&rsquo;s 7th bit</li><li><code>Z</code> is set if <code>memory byte AND A == 0</code>.</li></ul><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>flags</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mode</span><span class=p>):</span>
    <span class=n>v</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x3D</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=mh>0xC0</span> <span class=o>&amp;</span> <span class=n>v</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=nb>int</span><span class=p>((</span><span class=n>v</span> <span class=o>&amp;</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span>

<span class=o>...</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x24</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>flags</span><span class=p>(</span><span class=n>ZPG</span><span class=p>),</span>  <span class=c1># BIT,ZP,2,3,cZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x2C</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>flags</span><span class=p>(</span><span class=n>ABS</span><span class=p>),</span>  <span class=c1># BIT,ABS,3,4,cZidbVN</span>
</code></pre></div><p>Despite all the oddities, <code>BIT</code> is a useful instruction to check several bits at once without touching any of the A/X/Y registers.</p><h2 id=load-and-store>Load and store</h2><p>Executing two instructions of WozMon we&rsquo;ve disabled BCD mode and masked the interrupts.</p><p>Our third instruction is <code>A0 7F</code>, or <code>LDY #$7F</code>. It tells the CPU to load value 0x7f into <code>Y</code>. We can implement all LD/ST instructions at once, they are all the same except for the addressing mode:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xA9</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IMM</span><span class=p>))</span>  <span class=c1># LDA,IMM,2,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xA5</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPG</span><span class=p>))</span>  <span class=c1># LDA,ZP,2,3,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xB5</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPX</span><span class=p>))</span>  <span class=c1># LDA,ZPX,2,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xAD</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABS</span><span class=p>))</span>  <span class=c1># LDA,ABS,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xBD</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABX</span><span class=p>))</span>  <span class=c1># LDA,AX,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xB9</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABY</span><span class=p>))</span>  <span class=c1># LDA,AY,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xA1</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IZX</span><span class=p>))</span>  <span class=c1># LDA,ZIX,2,6,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xB1</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IZY</span><span class=p>))</span>  <span class=c1># LDA,ZIY,2,5,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xA2</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IMM</span><span class=p>))</span>  <span class=c1># LDX,IMM,2,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xA6</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPG</span><span class=p>))</span>  <span class=c1># LDX,ZP,2,3,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xB6</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPY</span><span class=p>))</span>  <span class=c1># LDX,ZPY,2,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xAE</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABS</span><span class=p>))</span>  <span class=c1># LDX,ABS,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xBE</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABY</span><span class=p>))</span>  <span class=c1># LDX,AY,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xA0</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IMM</span><span class=p>))</span>  <span class=c1># LDY,IMM,2,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xA4</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPG</span><span class=p>))</span>  <span class=c1># LDY,ZP,2,3,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xB4</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPX</span><span class=p>))</span>  <span class=c1># LDY,ZPX,2,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xAC</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABS</span><span class=p>))</span>  <span class=c1># LDY,ABS,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xBC</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABX</span><span class=p>))</span>  <span class=c1># LDY,AX,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x85</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># STA,ZP,2,3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x95</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># STA,ZPX,2,4,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x8D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># STA,ABS,3,4,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x9D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ABX</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># STA,AX,3,5,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x99</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ABY</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># STA,AY,3,5,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x81</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>IZX</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># STA,ZIX,2,6,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x91</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>IZY</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># STA,ZIY,2,6,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x86</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>  <span class=c1># STX,ZP,2,3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x96</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ZPY</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>  <span class=c1># STX,ZPY,2,4,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x8E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>  <span class=c1># STX,ABS,3,4,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x84</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>  <span class=c1># STY,ZP,2,3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x94</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>  <span class=c1># STY,ZPX,2,4,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x8C</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>  <span class=c1># STY,ABS,3,4,czidbvn</span>
</code></pre></div><p>ST operations copy contents from registers A/X/Y into memory, while LD operations copy from memory into A/X/Y and set N/Z flags.</p><p>Next WozMon instructions to run are 0x8C (STY), 0xA9 (LDA), 0x8D (STA) and another 0x8D (STA). All of them are implemented above.</p><p>So far we&rsquo;ve done 39 opcodes out of 151. If you now run the emulator for 7 steps and then print the contents of all registers &ndash; you will get <code>A7 00 7F FD</code>, which corresponds to the expected results from the first instructions of WozMon:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>RESET: CLD             ; Clear decimal arithmetic mode.
       CLI
       LDY #$7F        ; Mask for DSP data direction register.
       STY DSP         ; Set it up.
       LDA #$A7        ; KBD and DSP control register mask.
       STA KBDCR       ; Enable interrupts, set CA1, CB1, for
       STA DSPCR       ;  positive edge sense/output mode.
</code></pre></div><p>The next instruction to implement would be 0xC9 or <code>CMP</code>.</p><h2 id=branches>Branches</h2><p>CMP instruction compares a register A/X/Y to memory and updates:</p><ul><li><code>C</code> flag if register >= memory.</li><li><code>N</code> and <code>Z</code> flags based on the result of subtraction (register - memory).</li></ul><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>cmp</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
    <span class=n>m</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xFE</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>n</span> <span class=o>&gt;=</span> <span class=n>m</span><span class=p>))</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=n>m</span><span class=p>))</span>
</code></pre></div><p>Conditional branching in 6502 depends on the specific bit values from the flags. If the flag matches the branching condition - PC is increased by the signed byte value stored after the PC. Otherwise PC remains unchanged, pointing to the next instruction in code:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>branch</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>cond</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>addr</span><span class=p>(</span><span class=n>REL</span><span class=p>)</span> <span class=k>if</span> <span class=n>cond</span> <span class=k>else</span> <span class=mi>0</span>
<span class=o>...</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xC9</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>IMM</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># CMP,IMM,2,2,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xC5</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># CMP,ZP,2,3,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xD5</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># CMP,ZPX,2,4,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xCD</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># CMP,ABS,3,4,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xDD</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ABX</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># CMP,AX,3,4,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xD9</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ABY</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># CMP,AY,3,4,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xC1</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>IZX</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># CMP,ZIX,2,6,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xD1</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>IZY</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># CMP,ZIY,2,5,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xE0</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>IMM</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>  <span class=c1># CPX,IMM,2,2,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xE4</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>  <span class=c1># CPX,ZP,2,3,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xEC</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>  <span class=c1># CPX,ABS,3,4,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xC0</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>IMM</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>  <span class=c1># CPY,IMM,2,2,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xC4</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>  <span class=c1># CPY,ZP,2,3,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xCC</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cmp</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>  <span class=c1># CPY,ABS,3,4,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x90</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>+=</span> <span class=n>branch</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x01</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># BCC,REL,2,2/3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xB0</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>+=</span> <span class=n>branch</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x01</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># BCS,REL,2,2/3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xF0</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>+=</span> <span class=n>branch</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x02</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># BEQ,REL,2,2/3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x30</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>+=</span> <span class=n>branch</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># BMI,REL,2,2/3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xD0</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>+=</span> <span class=n>branch</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x02</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># BNE,REL,2,2/3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x10</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>+=</span> <span class=n>branch</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># BPL,REL,2,2/3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x50</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>+=</span> <span class=n>branch</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x40</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># BVC,REL,2,2/3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x70</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>+=</span> <span class=n>branch</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0x40</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># BVS,REL,2,2/3,czidbvn</span>
</code></pre></div><p>Once the branches are implemented, we can add unconditional jumps:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x4C</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>addr</span><span class=p>(</span><span class=n>ABS</span><span class=p>)</span>  <span class=c1># JMP,ABS,3,3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x6C</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>addr</span><span class=p>(</span><span class=n>IND</span><span class=p>)</span>  <span class=c1># JMP,IND,3,5,czidbvn</span>
</code></pre></div><p>Now we can run WozMon up until the opcode 0xC8 (<code>INY</code>).</p><h2 id=increments>Increments</h2><p>Some increment instructions are trivial and only increment registers (updating the N/Z flags):</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xCA</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>  <span class=c1># DEX,IMP,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x88</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>  <span class=c1># DEY,IMP,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xE8</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>  <span class=c1># INX,IMP,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xC8</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span>  <span class=c1># INY,IMP,1,2,cZidbvN</span>
</code></pre></div><p>But there is a few more (<code>INC</code> and <code>DEC</code>). They operate on memory bytes instead. For them we write another helper function that reads a byte from memory, increments it, updates the flags, and writes it back. We also combine increment and decrement into one function by providing a &ldquo;delta&rdquo; argument. If delta == 1 it&rsquo;s an increment, if delta == 0xff (-1) it&rsquo;s a decrement:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>def inc(self, mode, n):
    value = self.nz(u8(self.read(mode) + n))
    self.write(mode, value)

...
elif op == 0xE6: self.inc(ZPG, 1)  # INC,ZP,2,5,cZidbvN
elif op == 0xF6: self.inc(ZPX, 1)  # INC,ZPX,2,6,cZidbvN
elif op == 0xEE: self.inc(ABS, 1)  # INC,ABS,3,6,cZidbvN
elif op == 0xFE: self.inc(ABX, 1)  # INC,AX,3,7,cZidbvN
elif op == 0xC6: self.inc(ZPG, 0xFF)  # DEC,ZP,2,5,cZidbvN
elif op == 0xD6: self.inc(ZPX, 0xFF)  # DEC,ZPX,2,6,cZidbvN
elif op == 0xCE: self.inc(ABS, 0xFF)  # DEC,ABS,3,6,cZidbvN
elif op == 0xDE: self.inc(ABX, 0xFF)  # DEC,AX,3,7,cZidbvN
</code></pre></div><p>We&rsquo;ve already covered 75 opcodes out of 151, more than a half. This lets us execute 15 first instructions from WozMon, until we stop at opcode 0x20, or <code>JSR</code>.</p><h2 id=stack>Stack</h2><p>JSR instruction is rather simple: it pushes the program counter and jumps to the subroutine:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x20</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>push16</span><span class=p>(</span><span class=n>u16</span><span class=p>(</span><span class=n>next_pc</span> <span class=o>-</span> <span class=mi>1</span><span class=p>));</span> <span class=n>next_pc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>addr</span><span class=p>(</span><span class=n>ABS</span><span class=p>)</span> <span class=c1># JSR,ABS,3,6,czidbvn</span>
</code></pre></div><p>We can also implement <code>RTS</code> (return from subroutine) and <code>RTI</code> (return from interrupt):</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x60</span><span class=p>:</span> <span class=n>next_pc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pop16</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># RTS,IMP,1,6,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x40</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span> <span class=o>|</span> <span class=mh>0x20</span><span class=p>;</span> <span class=n>next_pc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pop16</span><span class=p>()</span> <span class=c1># RTI,IMP,1,6,czidbvn</span>
</code></pre></div><p>Since we are dealing with stack - why don&rsquo;t we add remaining push/pop instructions?</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x48</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>                   <span class=c1># PHA,IMP,1,3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x68</span><span class=p>:</span> <span class=n>n</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pop</span><span class=p>();</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=c1># PLA,IMP,1,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x08</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>|</span> <span class=mh>0x30</span><span class=p>)</span>            <span class=c1># PHP,IMP,1,3,czidbvn</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x28</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span> <span class=o>|</span> <span class=mh>0x20</span>          <span class=c1># PLP,IMP,1,4,CZIDBVN</span>
</code></pre></div><p>Now if we execute first 18 instructions &ndash; we get the long-awaited Apple I prompt, a mighty backslash:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>\
</code></pre></div><p>In fact, we can now step through instructions endlessly without a failure: WozMon is waiting for some user input in an infinite polling loop and never receives one.</p><h2 id=terminal-input>Terminal input</h2><p>We can now update the main loop to use <code>termios</code> and non-blocking keyboard polling:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>sys</span><span class=o>,</span> <span class=nn>termios</span><span class=o>,</span> <span class=nn>tty</span><span class=o>,</span> <span class=nn>select</span>
<span class=n>a1</span> <span class=o>=</span> <span class=n>AppleI</span><span class=p>()</span>
<span class=n>cpu</span> <span class=o>=</span> <span class=n>MOS6502</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
<span class=n>attr</span> <span class=o>=</span> <span class=n>termios</span><span class=o>.</span><span class=n>tcgetattr</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=p>)</span>
<span class=k>try</span><span class=p>:</span>
    <span class=n>tc</span> <span class=o>=</span> <span class=n>termios</span><span class=o>.</span><span class=n>tcgetattr</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=p>)</span>
    <span class=n>tc</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>tc</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>termios</span><span class=o>.</span><span class=n>ICANON</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>termios</span><span class=o>.</span><span class=n>ECHO</span><span class=p>)</span>
    <span class=n>termios</span><span class=o>.</span><span class=n>tcsetattr</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=p>,</span> <span class=n>termios</span><span class=o>.</span><span class=n>TCSAFLUSH</span><span class=p>,</span> <span class=n>tc</span><span class=p>)</span>
    <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
        <span class=n>cpu</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>select</span><span class=o>.</span><span class=n>select</span><span class=p>([</span><span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=p>],</span> <span class=p>[],</span> <span class=p>[],</span> <span class=mf>0.000001</span><span class=p>)</span> <span class=o>==</span> <span class=p>([</span><span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=p>],</span> <span class=p>[],</span> <span class=p>[]):</span>
            <span class=n>c</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
            <span class=n>a1</span><span class=o>.</span><span class=n>send_key</span><span class=p>(</span><span class=mi>13</span> <span class=k>if</span> <span class=n>c</span> <span class=o>==</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span> <span class=k>else</span> <span class=nb>ord</span><span class=p>(</span><span class=n>c</span><span class=p>))</span>
<span class=k>finally</span><span class=p>:</span>
    <span class=n>termios</span><span class=o>.</span><span class=n>tcsetattr</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=p>,</span> <span class=n>termios</span><span class=o>.</span><span class=n>TCSADRAIN</span><span class=p>,</span> <span class=n>attr</span><span class=p>)</span>
</code></pre></div><p>If we try typing something when the monitor is running &ndash; it will be echoed on our terminal. Not unusual at a first glance, however this time echoing is done by our Apple I emulator and WozMon ROM!</p><p>But, as soon as we hit &ldquo;Enter&rdquo; &ndash; emulator crashes at instruction 0xAA (<code>TAX</code>).</p><h2 id=transfer>Transfer</h2><p>Nobody likes TAX-es, but here it&rsquo;s an easy fix: those are just transfer instructions.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xAA</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># TAX,IMP,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x8A</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=p>)</span>  <span class=c1># TXA,IMP,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xA8</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>)</span>  <span class=c1># TAY,IMP,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x98</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=p>)</span>  <span class=c1># TYA,IMP,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xBA</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s</span><span class=p>)</span>  <span class=c1># TSX,IMP,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x9A</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>s</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span>  <span class=c1># TXS,IMP,1,2,czidbvn</span>
</code></pre></div><p>They swap the contents of registers A/X/Y with other registers.</p><p>The next one failing is 0x0A, or <code>ASL</code>. Time to implement bit shifting.</p><h2 id=bits-and-bytes>Bits and bytes</h2><p>Shifting in 6502 happens by 1 bit either way, left or right. Some instructions also wrap bits around, rotating the leftmost bit to the right and vice versa.
We can move this logic into a helper function:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>shift</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>left</span><span class=p>,</span> <span class=n>rot</span><span class=p>):</span>
    <span class=n>b</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>left</span><span class=p>:</span>
        <span class=n>r</span> <span class=o>=</span> <span class=n>u8</span><span class=p>((</span><span class=n>b</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>rot</span><span class=p>))</span>
        <span class=n>f</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xFE</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>b</span> <span class=o>&gt;&gt;</span> <span class=mi>7</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>r</span> <span class=o>=</span> <span class=n>u8</span><span class=p>((</span><span class=n>b</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>|</span> <span class=p>(((</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>7</span><span class=p>)</span> <span class=o>*</span> <span class=n>rot</span><span class=p>))</span>
        <span class=n>f</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xFE</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>b</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=n>f</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>mode</span><span class=p>,</span> <span class=n>r</span><span class=p>)</span>
</code></pre></div><p>We read a memory byte, we shift it. Carry bit may get rotated if <code>rot == 1</code>. Then new carry bit is set accordingly and N/Z bits are adjusted before the result is written back.</p><p>We can finish implementing all shifting/rotating opcodes:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x0A</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ACC</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ASL,ACC,1,2,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x06</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ASL,ZP,2,5,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x16</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ASL,ZPX,2,6,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x0E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ASL,ABS,3,6,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x1E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ABX</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ASL,AX,3,6/7,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x4A</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ACC</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># LSR,ACC,1,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x46</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># LSR,ZP,2,5,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x56</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># LSR,ZPX,2,6,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x4E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># LSR,ABS,3,6,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x5E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ABX</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># LSR,AX,3,6/7,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x2A</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ACC</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROL,ACC,1,2,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x26</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROL,ZP,2,5,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x36</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROL,ZPX,2,6,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x2E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROL,ABS,3,6,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x3E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ABX</span><span class=p>,</span> <span class=bp>True</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROL,AX,3,6/7,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x6A</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ACC</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROR,ACC,1,2,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x66</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROR,ZP,2,5,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x76</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROR,ZPX,2,6,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x7E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ABX</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROR,ABS,3,6,CZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x6E</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=bp>False</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># ROR,AX,3,6/7,CZidbvN</span>
</code></pre></div><p>We are now at 110/151 opcodes! The next failing instruction is 0x49, <code>EOR</code>.</p><p>Bitwise instructions can be implemented individually, or we may do a little trick and combine them into a single pipeline. Essentially, for any bitwise instruction we will be implementing all three of them: <code>((X & T) | U) ^ V)</code>. Here T, U and V can be set to certain values to only have one meaningful bitwise operation from the pipeline:</p><ul><li>AND: <code>((X & Y) | 0) ^ 0</code></li><li>OR: <code>((X & 0xff) | Y) ^ 0</code></li><li>EOR: <code>((X & 0ff) | 0) ^ Y</code></li></ul><p>Here&rsquo;s a helper function that calculates it all and updates N/Z flags:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>bit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>and_val</span><span class=p>,</span> <span class=n>or_val</span><span class=p>,</span> <span class=n>xor_val</span><span class=p>):</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>u8</span><span class=p>(((</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>&amp;</span> <span class=n>and_val</span><span class=p>)</span> <span class=o>|</span> <span class=n>or_val</span><span class=p>)</span> <span class=o>^</span> <span class=n>xor_val</span><span class=p>))</span>
</code></pre></div><p>And here are all bitwise opcodes:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x29</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IMM</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># AND,IMM,2,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x25</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPG</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># AND,ZP,2,3,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x35</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPX</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># AND,ZPX,2,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x2D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABS</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># AND,ABS,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x3D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABX</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># AND,AX,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x39</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABY</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># AND,AY,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x21</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IZX</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># AND,ZIX,2,6,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x31</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IZY</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># AND,ZIY,2,5,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x09</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IMM</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ORA,IMM,2,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x05</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPG</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ORA,ZP,2,3,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x15</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPX</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ORA,ZPX,2,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x0D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABS</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ORA,ABS,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x1D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABX</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ORA,AX,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x19</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABY</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ORA,AY,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x01</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IZX</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ORA,ZIX,2,6,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x11</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IZY</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ORA,ZIY,2,5,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x49</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IMM</span><span class=p>))</span>  <span class=c1># EOR,IMM,2,2,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x45</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPG</span><span class=p>))</span>  <span class=c1># EOR,ZP,2,3,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x55</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ZPX</span><span class=p>))</span>  <span class=c1># EOR,ZPX,2,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x4D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABS</span><span class=p>))</span>  <span class=c1># EOR,ABS,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x5D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABX</span><span class=p>))</span>  <span class=c1># EOR,AX,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x59</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>ABY</span><span class=p>))</span>  <span class=c1># EOR,AY,3,4,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x41</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IZX</span><span class=p>))</span>  <span class=c1># EOR,ZIX,2,6,cZidbvN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x51</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>bit</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>IZY</span><span class=p>))</span>  <span class=c1># EOR,ZIY,2,5,cZidbvN</span>
</code></pre></div><p>We are almost done. We only got 16 instructions left (addition/subtraction) and <code>NOP</code>. Well, <code>NOP</code> is opcode <code>0xEA</code> and it does nothing. Arithmetics, on the other hand, are interesting.</p><h2 id=plus-minus>Plus, minus</h2><p>This is the last helper function we need to make our MOS6502 emulator work. However, it&rsquo;s the one that operates in BCD and non-BCD modes differently.</p><p>In normal non-BCD mode, it simply adds the operand to accumulator (or subtracts, which is also addition, but with a negated value).</p><p>However, in BCD mode it treats both operands as 2-digit decimal numbers. So <code>0x43+0x28</code> becomes <code>0x71</code>, while in non-BCD it would be <code>0x6B</code>.</p><p>It&rsquo;s a pretty long helper function but it does the trick:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>adc</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>neg</span><span class=p>):</span>
    <span class=n>n</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mi>8</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>r</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>+</span> <span class=n>u16</span><span class=p>(</span><span class=n>n</span> <span class=o>^</span> <span class=p>(</span><span class=mh>0xFF</span> <span class=o>*</span> <span class=n>neg</span><span class=p>))</span> <span class=o>+</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
        <span class=n>v</span> <span class=o>=</span> <span class=n>u16</span><span class=p>((</span><span class=mh>0xFF</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>neg</span><span class=p>))</span> <span class=o>^</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>^</span> <span class=n>n</span><span class=p>))</span> <span class=o>&amp;</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>^</span> <span class=n>r</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x80</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xBE</span> <span class=o>|</span> <span class=p>((</span><span class=n>r</span> <span class=o>&amp;</span> <span class=mh>0x100</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=n>u8</span><span class=p>(</span><span class=n>v</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>(</span><span class=n>u8</span><span class=p>(</span><span class=n>r</span><span class=p>))</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>neg</span><span class=p>:</span>
            <span class=n>nd</span> <span class=o>=</span> <span class=p>((</span><span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>*</span> <span class=mi>10</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>n</span> <span class=o>&amp;</span> <span class=mh>0x0F</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>))</span>
            <span class=n>val</span> <span class=o>=</span> <span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>*</span> <span class=mi>10</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>&amp;</span> <span class=mh>0x0F</span><span class=p>)</span> <span class=o>-</span> <span class=n>nd</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>|</span> <span class=mi>1</span>
            <span class=k>if</span> <span class=n>val</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xFE</span>
                <span class=n>val</span> <span class=o>=</span> <span class=n>val</span> <span class=o>+</span> <span class=mi>100</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>((</span><span class=nb>int</span><span class=p>(</span><span class=n>val</span> <span class=o>/</span> <span class=mi>10</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>val</span> <span class=o>%</span> <span class=mi>10</span><span class=p>)))</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>p1</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>n</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
            <span class=n>p2</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p1</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>&amp;</span> <span class=mh>0xFE</span>
            <span class=k>if</span> <span class=n>p1</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>:</span>
                <span class=n>p1</span> <span class=o>=</span> <span class=n>p1</span> <span class=o>-</span> <span class=mi>10</span>
            <span class=k>if</span> <span class=n>p2</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>f</span> <span class=o>|</span> <span class=mi>1</span>
                <span class=n>p2</span> <span class=o>=</span> <span class=n>p2</span> <span class=o>-</span> <span class=mi>10</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>nz</span><span class=p>((</span><span class=n>p2</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=n>p1</span><span class=p>))</span>
</code></pre></div><p>Now we can use it in our step() method:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x69</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>IMM</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ADC,IMM,2,2,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x65</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ADC,ZP,2,3,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x75</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ADC,ZPX,2,4,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x6D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ADC,ABS,3,4,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x7D</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ABX</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ADC,AX,3,4,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x79</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ABY</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ADC,AY,3,4,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x61</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>IZX</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ADC,ZIX,2,6,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0x71</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>IZY</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># ADC,ZIY,2,5,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xE9</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>IMM</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># SBC,IMM,2,2,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xE5</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ZPG</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># SBC,ZP,2,3,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xF5</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ZPX</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># SBC,ZPX,2,4,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xED</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ABS</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># SBC,ABS,3,4,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xFD</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ABX</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># SBC,AX,3,4,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xF9</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>ABY</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># SBC,AY,3,4,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xE1</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>IZX</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># SBC,ZIX,2,6,CZidbVN</span>
<span class=k>elif</span> <span class=n>op</span> <span class=o>==</span> <span class=mh>0xF1</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>adc</span><span class=p>(</span><span class=n>IZY</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># SBC,ZIY,2,5,CZidbVN</span>
</code></pre></div><p>And, we are done! In fact, BCD mode is not required for WozMon to work correctly, but you will definitely need it to run Apple BASIC.</p><p>You can now run WozMon, enter some address &ndash; and it will print the memory byte there, proving that it works.</p><p>We can even type-in our first &ldquo;Hello World&rdquo; program for Apple I:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>\
# Type this to show contents of last 256 bytes, i.e WozMon code:
FF00.FFFF 

FF00: D8 58 A0 7F 8C 12 D0 A9
FF08: A7 8D 11 D0 8D 13 D0 C9
FF10: DF F0 13 C9 9B F0 03 C8
...
FFE8: B0 C9 BA 90 02 69 06 2C
FFF0: 12 D0 30 FB 8D 12 D0 60
FFF8: 00 00 00 0F 00 FF 00 00

# Type this for a HELLO WORLD program:
280:A2 C BD 8B 2 20 EF FF CA D0 F7 60 8D C4 CC D2 CF D7 A0 CF CC CC C5 C8
280.297
280
R

HELLO WORLD
</code></pre></div><p>Curious what have just happened? WozMon accepts single addresses in hexadecimal form and prints the contents. Two addresses separated by a dot specify a memory range to display. Address followed by a colon store following bytes from that address onwards. Finally, &ldquo;R&rdquo; runs code from the last entered address.</p><p>The series of bytes now becomes clear if you look up all the opcodes in our <code>step()</code> method, or use a disassembler:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>                            * = $0280
0280   A2 0C                LDX #$0C
0282   BD 8B 02   L0282     LDA $028B,X
0285   20 EF FF             JSR $FFEF
0288   CA                   DEX
0289   D0 F7                BNE L0282
028B   60                   RTS
028C   8D C4 CC D2 CF D7 A0 CF CC CC C5 C8
      &#34;\r D  L  R  O  W     O  L  L  E  H&#34;
                           .END
</code></pre></div><p>In other words:</p><ul><li>We set X=12 (length of &ldquo;HELLO WORLD&rdquo; message).</li><li>We read byte at [0x2BB+X] into A.</li><li>We call subroutine at 0xFFEF (WozMon&rsquo;s &ldquo;ECHO&rdquo; routine that prints one character stored in A).</li><li>We decrease X by 1.</li><li>We go back to step 2 (0282) as long as X != 0.</li></ul><p>Unfortunately, original WozMon calls user code using JMP and not JSR, so our program crashes at the end. You might want to fix it in either WozMon code, or in the app code (using <code>JMP $FF1F</code> instead of <code>RTS</code> at 0x28B).</p><h2 id=basic>BASIC</h2><p>Can we emulate a full Apple I computer now? Yes! Our memory bus implementation lacks a few ROMs, but it&rsquo;s not hard to add: we should load original &ldquo;Integer BASIC&rdquo; ROM and cassette interface (ACI) ROM into their addresses and we are good to go:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>WOZACI = base64.b64decode(&#39;qaog7/+pjSDv/6D/yK0R0BD7rRDQmQACIO//yZvw4cmN0Omi/6kAhSSFJYUmhSfovQACydLwVsnX8DXJrvAnyY3wIMmg8OhJsMkKkAZpiMn6kK0KCgoKoAQKJiQmJYjQ+PDMTBr/pSSFJqUlhSewv6lAIMzBiKIAoSaiEAog28HQ+iDxwaAekOymKLCYILzBqRYgzMEgvMGgHyC/wbD5IL/BoDqiCEggvMFoKqA5ytD1gSYg8cGgNZDqsM0gv8GIrYHAxSnw+IUpwIBghiigQiDgwdD5af6w9aAeIODBoCyI0P2QBaAviND9vADAoCnKYKUmxSSlJ+Ul5ibQAuYnYA==&#39;)
INTBASIC = base64.b64decode(&#39;TLDirRHQEPutEN....&#39;) # 4KB of data here

class AppleI:
  def __init__(self):
    self.keys = []
    self.mem = bytearray(0x2000)
  def __getitem__(self, i):
    if i &gt;= 0 and i &lt;= 0x2000: return self.mem[i] # 8K RAM
    elif i &gt;= 0xc100 and i &lt;= 0xc1ff: return WOZACI[i - 0xc100]
    elif i &gt;= 0xff00 and i &lt;= 0xffff: return WOZMON[i - 0xff00]
    elif i &gt;= 0xe000 and i &lt;= 0xefff: return INTBASIC[i - 0xe000]
    elif i == 0xd010: return self.keys.pop(0)|0x80 if len(self.keys) else 0x80
    elif i == 0xd011: return 0x80 if len(self.keys) else 0
    else: return 0
  def __setitem__(self, i, n):
    if i &gt;= 0 and i &lt; 0x0fff: self.mem[i] = n
    elif i == 0xd012:
      if n &amp; 0x7f == 0x0d: print(&#39;&#39;)
      elif n &amp; 0x7f == 0x5f: print(&#39;\b&#39;, end = &#39;&#39;, flush=True)
      else: print(chr(n&amp;0x7f), end=&#39;&#39;, flush=True)
  def send_key(self, c):
    self.keys.append(c)
</code></pre></div><p>Starting it up and typing the famous &ldquo;E000R&rdquo; into monitor loads Integer BASIC! Here &ldquo;E000&rdquo; address is the beginning of BASIC ROM and &ldquo;R&rdquo; is a WozMon command to run code:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>\
E000R
&gt; PRINT &#34;HELLO&#34;
HELLO
&gt; 10 PRINT &#34;6502 IS COOL&#34;
&gt; 20 GOTO 10
&gt; RUN
</code></pre></div><h2 id=whats-next>What&rsquo;s next</h2><p>You&rsquo;ve got a working 6502 emulator. Full code is here: <a href=https://gist.github.com/zserge/e5a18c954ab18b5b07be7ff516b5387a>https://gist.github.com/zserge/e5a18c954ab18b5b07be7ff516b5387a</a> and it&rsquo;s under 300 LOC.</p><p>I&rsquo;ve also implemented it in a similar manner in C and it can run plenty of Apple I programs, as well as emulate KIM-1 computer: <a href=https://github.com/zserge/bsoz>https://github.com/zserge/bsoz</a></p><p>Feel free to report bugs, or simply use in your projects. Both emulators are not cycle-accurate, but it&rsquo;s not so hard to add. Most instructions run at a fixed number of cycles per instruction, but some need to check for page boundaries to add an extra cycle.</p><p>Python code from this article works nicely with MicroPython/CircuitPython, so you may use it in embedded projects to emulate 6502 on some low-end hardware. You may even build an Apple I replica using Arduino, RP2040 or ESP32. I was able to run it on a pocket Cardputer earlier this year.</p><p>Well, I hope it was a useful journey into emulation and retrocomputers. Have fun!</p><p>I hope you’ve enjoyed this article. You can follow – and contribute to – on <a href=https://github.com/zserge>Github</a>, <a href=https://mastodon.social/@zserge>Mastodon</a>, <a href=https://twitter.com/zsergo>Twitter</a> or subscribe via <a href=/rss.xml>rss</a>.</p><p class=date style=text-align:right><em>Dec 28, 2024</em></p><p>See also:
<a href=/posts/langs-apl/>Tiny Great Languages: APL</a> and <a href=/posts/>more</a>.</p></div><footer><p>&copy;2012&ndash;2025 &#183;
<a class=h-card rel=me href=https://zserge.com/>Serge Zaitsev</a> &#183;
<a href=mailto:hello@zserge.com rel=me>hello@zserge.com</a> &#183;
<a href=https://mastodon.social/@zserge rel=me>@zserge@mastodon.social</a></p></footer><script>new Image().src='https://nullitics.com/file.gif?u='+encodeURI(location.href)+'&r='+encodeURI(document.referrer)+'&d='+screen.width</script><noscript><img src=https://nullitics.com/file.gif></noscript></body></html>