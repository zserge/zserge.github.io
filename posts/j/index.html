<!doctype html><html lang=en><head><meta charset=utf-8><title>Ode to J</title><meta name=description content="From a confusing page of old C code to APL/J praise."><meta name=author content="Serge Zaitsev"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=data:,><link rel="shortcut icon" sizes=32x32 href=/favicon.png><link rel="shortcut icon" sizes=192x192 href=/favicon-192x192.png><link rel=apple-touch-icon href=/favicon-192x192.png><link rel=alternate type=application/rss+xml title=RSS href=/rss.xml><link rel=canonical href=https://zserge.com/posts/j/><meta property="og:title" content="Ode to J"><meta property="og:type" content="article"><meta property="og:url" content="https://zserge.com/posts/j/"><meta property="og:image" content="https://zserge.com/logo.png"><meta property="og:description" content="From a confusing page of old C code to APL/J praise."><meta property="og:locale" content="en_US"><meta name=twitter:card content="From a confusing page of old C code to APL/J praise."><meta name=twitter:site content="@zsergo"><style type=text/css>body{padding:1rem;margin:auto;max-width:46rem;font-family:pt serif,Georgia,Cambria,times new roman,Times,serif;line-height:1.5;font-size:20px;color:rgba(0,0,0,.87);-webkit-font-smoothing:antialiased;font-weight:300}nav{display:flex;justify-content:space-between;align-items:center;margin:1em 0 3em}nav ul,nav li{display:inline-block;list-style:none;margin:0 0 0 .5rem;padding:0}nav ul{margin-right:1rem}.logo{background-color:rgba(0,0,0,.87);color:#fff;min-width:48px;min-height:48px;font-size:28px;border-radius:2px;display:flex;justify-content:center;align-items:center}.logo:hover{color:#fff}h1,h2{line-height:1.2;font-family:roboto,system-ui,segoe ui,Helvetica,Arial,sans-serif;font-weight:400;text-transform:uppercase;margin:1.34em 0 0}h1{font-size:1.95em}h2{font-size:1.25em;border-bottom:2px solid rgba(0,0,0,.87)}h1 a{color:rgba(0,0,0,.87)}p{margin:.67em 0 1em}a{color:#0076df;text-decoration:none;word-break:break-word}a:hover{color:rgba(0,0,0,.87)}ul,ol{list-style-position:outside;margin-left:1em}img{display:block;margin-left:auto;margin-right:auto;max-width:100%}pre,code{font-family:roboto mono,SFMono-Regular,Consolas,liberation mono,Menlo,monospace;font-weight:400;font-size:18px;color:rgba(0,0,0,.6);background:#eee}code{padding:.2rem .4rem;font-size:14px;border-radius:2px}pre{overflow-y:auto;line-height:20px;border-radius:2px;padding:1em}pre code{font-size:14px;padding:0;color:rgba(0,0,0,.87)}footer{font-size:12px}@media(prefers-color-scheme:dark){.logo{color:#444;background-color:#e4e4e4}.logo:hover{color:#444}body,h1 a,h2 a{background-color:#444;color:#e4e4e4}pre,pre code{background:#333;color:#e4e4e4}h2{border-bottom:1px solid #e4e4e4}code{color:#aaa;background:#333}a{color:#e39777}a:hover{color:#e4e4e4}img{filter:grayscale(30%)}}.hl{display:block;width:100%;background-color:#ffc}.ow,.gh,.gp,.gs,.gu,.nt,.nn,.ne,.ni,.nc,.kr,.kn,.kd,.kc,.k{font-weight:700}.c,.ch,.cm,.c1,.cs,.ge{color:#777}</style><link rel="shortcut icon" href=/favicon.ico></head><body><header><nav><a class=logo href=/>Z</a><ul><li><a href=/about/>about</a></li><li><a href=/posts/>posts</a></li><li><a href=https://twitter.com/zsergo>@me</a></li><li><a href=https://github.com/zserge>&lt;/>me</a></li></ul></nav></header><div id=content><h1>Ode to J</h1><p>While self-isolating orchestras and amateur musicians are playing &lsquo;Ode to Joy&rsquo;
from their open windows, I would like to give it a try with my ode to <a href=https://en.wikipedia.org/wiki/J_(programming_language>J</a>.</p><p>If you read the Hacker News or other programming resources, you probably have read <a href=https://code.jsoftware.com/wiki/Essays/Incunabulum>the following passage</a>:</p><p>&ldquo;One summer weekend in 1989, Arthur Whitney visited Ken Iverson at Kiln Farm and produced—on one page and in one afternoon—an interpreter fragment on the AT&T 3B1 computer. I studied this interpreter for about a week for its organization and programming style; and on Sunday, August 27, 1989, at about four o&rsquo;clock in the afternoon, wrote the first line of code that became the implementation described in this document.&rdquo; (An Implementation of J, Appendix A: Incunabulum).</p><p>It was the beginning of the story of the J language, a weird-looking array programming language. This family of languages is notable for their terse notation, where a clever one-liner can represent what would have taken a page of Java code.</p><p>For example a common for loop <code>for (int i = 0; i &lt; n; i++) a[i] += b[i];</code> in J would simple become <code>a=:a+b</code>.</p><p>It&rsquo;s no wonder that the snippet of code that inspired the creation of the J language is also very concise:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=kt>char</span> <span class=n>C</span><span class=p>;</span><span class=k>typedef</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>I</span><span class=p>;</span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=n>a</span><span class=p>{</span><span class=n>I</span> <span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span><span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>];}</span><span class=o>*</span><span class=n>A</span><span class=p>;</span>
<span class=cp>#define P printf
</span><span class=cp>#define R return
</span><span class=cp>#define V1(f) A f(w)A w;
</span><span class=cp>#define V2(f) A f(a,w)A a,w;
</span><span class=cp>#define DO(n,x) {I i=0,_n=(n);for(;i&lt;_n;++i){x;}}
</span><span class=cp></span><span class=n>I</span> <span class=o>*</span><span class=nf>ma</span><span class=p>(</span><span class=n>n</span><span class=p>){</span><span class=n>R</span><span class=p>(</span><span class=n>I</span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=n>n</span><span class=o>*</span><span class=mi>8</span><span class=p>);}</span><span class=n>mv</span><span class=p>(</span><span class=n>d</span><span class=p>,</span><span class=n>s</span><span class=p>,</span><span class=n>n</span><span class=p>)</span><span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>,</span><span class=o>*</span><span class=n>s</span><span class=p>;{</span><span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]);}</span>
<span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>)</span><span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>;{</span><span class=n>I</span> <span class=n>z</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>DO</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>z</span><span class=o>=</span><span class=n>z</span><span class=o>*</span><span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>A</span> <span class=n>ga</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>)</span><span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>;{</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=p>(</span><span class=n>A</span><span class=p>)</span><span class=n>ma</span><span class=p>(</span><span class=mi>5</span><span class=o>+</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>));</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>t</span><span class=o>=</span><span class=n>t</span><span class=p>,</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>r</span><span class=o>=</span><span class=n>r</span><span class=p>,</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span><span class=n>d</span><span class=p>,</span><span class=n>r</span><span class=p>);</span>
 <span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V1</span><span class=p>(</span><span class=n>iota</span><span class=p>){</span><span class=n>I</span> <span class=n>n</span><span class=o>=*</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>;</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=o>&amp;</span><span class=n>n</span><span class=p>);</span><span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>i</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V2</span><span class=p>(</span><span class=n>plus</span><span class=p>){</span><span class=n>I</span> <span class=n>r</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=o>*</span><span class=n>d</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span>
 <span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>+</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V2</span><span class=p>(</span><span class=n>from</span><span class=p>){</span><span class=n>I</span> <span class=n>r</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=o>*</span><span class=n>d</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span>
 <span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>+</span><span class=p>(</span><span class=n>n</span><span class=o>**</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>),</span><span class=n>n</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V1</span><span class=p>(</span><span class=n>box</span><span class=p>){</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span><span class=o>*</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>=</span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>w</span><span class=p>;</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V2</span><span class=p>(</span><span class=n>cat</span><span class=p>){</span><span class=n>I</span> <span class=n>an</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>),</span><span class=n>wn</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>),</span><span class=n>n</span><span class=o>=</span><span class=n>an</span><span class=o>+</span><span class=n>wn</span><span class=p>;</span>
 <span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=o>&amp;</span><span class=n>n</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>an</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>+</span><span class=n>an</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>wn</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V2</span><span class=p>(</span><span class=n>find</span><span class=p>){}</span>
<span class=n>V2</span><span class=p>(</span><span class=n>rsh</span><span class=p>){</span><span class=n>I</span> <span class=n>r</span><span class=o>=</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>r</span><span class=o>?*</span><span class=n>a</span><span class=o>-&gt;</span><span class=nl>d</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>),</span><span class=n>wn</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>);</span>
 <span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>wn</span><span class=o>=</span><span class=n>n</span><span class=o>&gt;</span><span class=n>wn</span><span class=o>?</span><span class=nl>wn</span><span class=p>:</span><span class=n>n</span><span class=p>);</span>
 <span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=o>-=</span><span class=n>wn</span><span class=p>)</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>+</span><span class=n>wn</span><span class=p>,</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>n</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V1</span><span class=p>(</span><span class=n>sha</span><span class=p>){</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=o>&amp;</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V1</span><span class=p>(</span><span class=n>id</span><span class=p>){</span><span class=n>R</span> <span class=n>w</span><span class=p>;}</span><span class=n>V1</span><span class=p>(</span><span class=n>size</span><span class=p>){</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span><span class=o>*</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=o>?*</span><span class=n>w</span><span class=o>-&gt;</span><span class=nl>d</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>pi</span><span class=p>(</span><span class=n>i</span><span class=p>){</span><span class=n>P</span><span class=p>(</span><span class=s>&#34;%d &#34;</span><span class=p>,</span><span class=n>i</span><span class=p>);}</span><span class=n>nl</span><span class=p>(){</span><span class=n>P</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);}</span>
<span class=n>pr</span><span class=p>(</span><span class=n>w</span><span class=p>)</span><span class=n>A</span> <span class=n>w</span><span class=p>;{</span><span class=n>I</span> <span class=n>r</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=o>*</span><span class=n>d</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span><span class=n>DO</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>pi</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]));</span><span class=n>nl</span><span class=p>();</span>
 <span class=k>if</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>)</span><span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>P</span><span class=p>(</span><span class=s>&#34;&lt; &#34;</span><span class=p>);</span><span class=n>pr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span><span class=k>else</span> <span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>pi</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]));</span><span class=n>nl</span><span class=p>();}</span>

<span class=n>C</span> <span class=n>vt</span><span class=p>[]</span><span class=o>=</span><span class=s>&#34;+{~&lt;#,&#34;</span><span class=p>;</span>
<span class=n>A</span><span class=p>(</span><span class=o>*</span><span class=n>vd</span><span class=p>[])()</span><span class=o>=</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=n>plus</span><span class=p>,</span><span class=n>from</span><span class=p>,</span><span class=n>find</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>rsh</span><span class=p>,</span><span class=n>cat</span><span class=p>},</span>
 <span class=p>(</span><span class=o>*</span><span class=n>vm</span><span class=p>[])()</span><span class=o>=</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=n>id</span><span class=p>,</span><span class=n>size</span><span class=p>,</span><span class=n>iota</span><span class=p>,</span><span class=n>box</span><span class=p>,</span><span class=n>sha</span><span class=p>,</span><span class=mi>0</span><span class=p>};</span>
<span class=n>I</span> <span class=n>st</span><span class=p>[</span><span class=mi>26</span><span class=p>];</span> <span class=n>qp</span><span class=p>(</span><span class=n>a</span><span class=p>){</span><span class=n>R</span>  <span class=n>a</span><span class=o>&gt;=</span><span class=sc>&#39;a&#39;</span><span class=o>&amp;&amp;</span><span class=n>a</span><span class=o>&lt;=</span><span class=sc>&#39;z&#39;</span><span class=p>;}</span><span class=n>qv</span><span class=p>(</span><span class=n>a</span><span class=p>){</span><span class=n>R</span> <span class=n>a</span><span class=o>&lt;</span><span class=sc>&#39;a&#39;</span><span class=p>;}</span>
<span class=n>A</span> <span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=n>I</span> <span class=o>*</span><span class=n>e</span><span class=p>;{</span><span class=n>I</span> <span class=n>a</span><span class=o>=*</span><span class=n>e</span><span class=p>;</span>
 <span class=k>if</span><span class=p>(</span><span class=n>qp</span><span class=p>(</span><span class=n>a</span><span class=p>)){</span><span class=k>if</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>==</span><span class=sc>&#39;=&#39;</span><span class=p>)</span><span class=n>R</span> <span class=n>st</span><span class=p>[</span><span class=n>a</span><span class=o>-</span><span class=sc>&#39;a&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>2</span><span class=p>);</span><span class=n>a</span><span class=o>=</span> <span class=n>st</span><span class=p>[</span> <span class=n>a</span><span class=o>-</span><span class=sc>&#39;a&#39;</span><span class=p>];}</span>
 <span class=n>R</span> <span class=n>qv</span><span class=p>(</span><span class=n>a</span><span class=p>)</span><span class=o>?</span><span class=p>(</span><span class=o>*</span><span class=n>vm</span><span class=p>[</span><span class=n>a</span><span class=p>])(</span><span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>:</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>?</span><span class=p>(</span><span class=o>*</span><span class=n>vd</span><span class=p>[</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>]])(</span><span class=n>a</span><span class=p>,</span><span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>2</span><span class=p>))</span><span class=o>:</span><span class=p>(</span><span class=n>A</span><span class=p>)</span><span class=n>a</span><span class=p>;}</span>
<span class=n>noun</span><span class=p>(</span><span class=n>c</span><span class=p>){</span><span class=n>A</span> <span class=n>z</span><span class=p>;</span><span class=k>if</span><span class=p>(</span><span class=n>c</span><span class=o>&lt;</span><span class=sc>&#39;0&#39;</span><span class=o>||</span><span class=n>c</span><span class=o>&gt;</span><span class=sc>&#39;9&#39;</span><span class=p>)</span><span class=n>R</span> <span class=mi>0</span><span class=p>;</span><span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span><span class=o>*</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>=</span><span class=n>c</span><span class=o>-</span><span class=sc>&#39;0&#39;</span><span class=p>;</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>verb</span><span class=p>(</span><span class=n>c</span><span class=p>){</span><span class=n>I</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=k>for</span><span class=p>(;</span><span class=n>vt</span><span class=p>[</span><span class=n>i</span><span class=p>];)</span><span class=k>if</span><span class=p>(</span><span class=n>vt</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]</span><span class=o>==</span><span class=n>c</span><span class=p>)</span><span class=n>R</span> <span class=n>i</span><span class=p>;</span><span class=n>R</span> <span class=mi>0</span><span class=p>;}</span>
<span class=n>I</span> <span class=o>*</span><span class=n>wd</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=n>C</span> <span class=o>*</span><span class=n>s</span><span class=p>;{</span><span class=n>I</span> <span class=n>a</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=o>*</span><span class=n>e</span><span class=o>=</span><span class=n>ma</span><span class=p>(</span><span class=n>n</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span><span class=n>C</span> <span class=n>c</span><span class=p>;</span>
 <span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=n>noun</span><span class=p>(</span><span class=n>c</span><span class=o>=</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span><span class=o>?</span><span class=nl>a</span><span class=p>:(</span><span class=n>a</span><span class=o>=</span><span class=n>verb</span><span class=p>(</span><span class=n>c</span><span class=p>))</span><span class=o>?</span><span class=nl>a</span><span class=p>:</span><span class=n>c</span><span class=p>);</span><span class=n>e</span><span class=p>[</span><span class=n>n</span><span class=p>]</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>R</span> <span class=n>e</span><span class=p>;}</span>

<span class=n>main</span><span class=p>(){</span><span class=n>C</span> <span class=n>s</span><span class=p>[</span><span class=mi>99</span><span class=p>];</span><span class=k>while</span><span class=p>(</span><span class=n>gets</span><span class=p>(</span><span class=n>s</span><span class=p>))</span><span class=n>pr</span><span class=p>(</span><span class=n>ex</span><span class=p>(</span><span class=n>wd</span><span class=p>(</span><span class=n>s</span><span class=p>)));}</span>
</code></pre></div><p>I dared to update the code a little bit, originally it was using <code>long</code> data type, and was casting it to pointers, which are 64-bit these days. So I replaced it with <code>long long</code> to be able to run this code.</p><p>Yes, it looks weird to modern eyes. Even if we prettify the code with clang-format - we will still find that it uses old-school K&R coding style and it&rsquo;s a miracle that this code is 30 years old and still works.</p><p>What does it do? Well, it&rsquo;s an interpreter. Yes, it&rsquo;s a tiny array programming language, like APL or K. It has certain limitations that we will discover later, but for now I invite you to the journey of deciphering this code.</p><h2 id=data-types>Data types</h2><p>As we are dealing with an array programming language, the only data type it supports is an array. Arrays may contain numbers, or other nested arrays, which is known as &ldquo;boxing&rdquo;.</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=n>a</span><span class=p>{</span><span class=n>I</span> <span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span><span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>];}</span><span class=o>*</span><span class=n>A</span><span class=p>;</span>
<span class=c1>// or
</span><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>t</span><span class=p>;</span> <span class=c1>// t=0: normal array, t=1: &#34;boxed&#34;
</span><span class=c1></span>  <span class=n>I</span> <span class=n>r</span><span class=p>;</span> <span class=c1>// rank: number of dimensions
</span><span class=c1></span>  <span class=n>I</span> <span class=n>d</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span> <span class=c1>// depth: size in each dimension (up to 3)
</span><span class=c1></span>  <span class=n>I</span> <span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span> <span class=c1>// array data - numbers mixed with pointers
</span><span class=c1></span><span class=p>}</span> <span class=o>*</span><span class=n>A</span><span class=p>;</span>
</code></pre></div><p>As you can see, arrays are limited to only integer elements, may contain other arrays and may have up to 3 dimensions (linear vectors, rectangular matrices and 3-dimensional arrays.</p><p>The fixed size of 2 for data array was probably chosen to avoid dynamic memory allocation for single numbers (arrays of zero rank with one element). But I suspect it has not been used correctly (I might be wrong, though).</p><p>For allocating integer arrays there is a helper function &ldquo;ma&rdquo;, which only wraps malloc to allocate <code>n</code> integers:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>I</span> <span class=o>*</span><span class=nf>ma</span><span class=p>(</span><span class=n>n</span><span class=p>){</span><span class=n>R</span><span class=p>(</span><span class=n>I</span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=n>n</span><span class=o>*</span><span class=mi>8</span><span class=p>);}</span>
<span class=c1>// or
</span><span class=c1></span><span class=k>typedef</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>I</span><span class=p>;</span>
<span class=n>I</span> <span class=o>*</span><span class=nf>ma</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=p>(</span><span class=n>I</span> <span class=o>*</span><span class=p>)</span> <span class=n>malloc</span><span class=p>(</span><span class=n>n</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>I</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div><p>For copying array elements there is a hand-written memmove:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>mv</span><span class=p>(</span><span class=n>d</span><span class=p>,</span><span class=n>s</span><span class=p>,</span><span class=n>n</span><span class=p>)</span><span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>,</span><span class=o>*</span><span class=n>s</span><span class=p>;{</span><span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]);}</span>
<span class=c1>// or
</span><span class=c1></span><span class=kt>void</span> <span class=n>mv</span><span class=p>(</span><span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>,</span> <span class=n>I</span> <span class=o>*</span><span class=n>s</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>As you see, <code>DO(n, op)</code> is a macro to avoid numerous for-loops, that are untypical in the array programming nature.</p><p>Then goes a function to multiply dimensions in each rank (to get the total number of elements in all dimensions):</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>)</span><span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>;{</span><span class=n>I</span> <span class=n>z</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>DO</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>z</span><span class=o>=</span><span class=n>z</span><span class=o>*</span><span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=c1>// or
</span><span class=c1></span><span class=n>I</span> <span class=n>tr</span><span class=p>(</span><span class=n>I</span> <span class=n>r</span><span class=p>,</span> <span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>z</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>r</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>z</span> <span class=o>=</span> <span class=n>z</span> <span class=o>*</span> <span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>It is commonly used before calling DO() to apply some operation to all elements in all dimensions of an array.</p><p>Finally, there is a constructor for the array type:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>A</span> <span class=nf>ga</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>)</span><span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>;{</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=p>(</span><span class=n>A</span><span class=p>)</span><span class=n>ma</span><span class=p>(</span><span class=mi>5</span><span class=o>+</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>));</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>t</span><span class=o>=</span><span class=n>t</span><span class=p>,</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>r</span><span class=o>=</span><span class=n>r</span><span class=p>,</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span><span class=n>d</span><span class=p>,</span><span class=n>r</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=c1>// or
</span><span class=c1></span><span class=n>A</span> <span class=n>ga</span><span class=p>(</span><span class=n>I</span> <span class=n>t</span><span class=p>,</span> <span class=n>I</span> <span class=n>r</span><span class=p>,</span> <span class=n>I</span> <span class=o>*</span><span class=n>d</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=p>(</span><span class=n>A</span><span class=p>)</span> <span class=n>ma</span><span class=p>(</span><span class=mi>5</span> <span class=o>+</span> <span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>d</span><span class=p>));</span> <span class=c1>// tr() returns number of elements here
</span><span class=c1></span>  <span class=n>z</span><span class=o>-&gt;</span><span class=n>t</span> <span class=o>=</span> <span class=n>t</span><span class=p>;</span>
  <span class=n>z</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>=</span> <span class=n>r</span><span class=p>;</span>
  <span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h2 id=parser>parser</h2><p>Now I suggest to skip the part with many V1 and V2 functions, and jump to the end of the program, the main function:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>main</span><span class=p>(){</span><span class=n>C</span> <span class=n>s</span><span class=p>[</span><span class=mi>99</span><span class=p>];</span><span class=k>while</span><span class=p>(</span><span class=n>gets</span><span class=p>(</span><span class=n>s</span><span class=p>))</span><span class=n>pr</span><span class=p>(</span><span class=n>ex</span><span class=p>(</span><span class=n>wd</span><span class=p>(</span><span class=n>s</span><span class=p>)));}</span>
<span class=c1>// or
</span><span class=c1></span><span class=kt>int</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
  <span class=kt>char</span> <span class=n>s</span><span class=p>[</span><span class=mi>99</span><span class=p>];</span>             <span class=c1>// maximum input line length
</span><span class=c1></span>  <span class=k>while</span> <span class=p>(</span><span class=n>gets</span><span class=p>(</span><span class=n>s</span><span class=p>))</span> <span class=p>{</span>       <span class=c1>// until end of input:
</span><span class=c1></span>    <span class=n>I</span> <span class=o>*</span><span class=n>words</span> <span class=o>=</span> <span class=n>wd</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>     <span class=c1>// tokenize input
</span><span class=c1></span>    <span class=n>A</span> <span class=n>result</span> <span class=o>=</span> <span class=n>ex</span><span class=p>(</span><span class=n>words</span><span class=p>);</span> <span class=c1>// evaluate words
</span><span class=c1></span>    <span class=n>pr</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>           <span class=c1>// print result
</span><span class=c1></span>  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Yes, it&rsquo;s a simple REPL (read-eval-print) loop, that we commonly see in every interpreter.</p><p>Let&rsquo;s have a look at the parser (which is only a tokenizer in fact):</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>C</span> <span class=n>vt</span><span class=p>[]</span><span class=o>=</span><span class=s>&#34;+{~&lt;#,&#34;</span><span class=p>;</span>
<span class=n>noun</span><span class=p>(</span><span class=n>c</span><span class=p>){</span><span class=n>A</span> <span class=n>z</span><span class=p>;</span><span class=k>if</span><span class=p>(</span><span class=n>c</span><span class=o>&lt;</span><span class=sc>&#39;0&#39;</span><span class=o>||</span><span class=n>c</span><span class=o>&gt;</span><span class=sc>&#39;9&#39;</span><span class=p>)</span><span class=n>R</span> <span class=mi>0</span><span class=p>;</span><span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span><span class=o>*</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>=</span><span class=n>c</span><span class=o>-</span><span class=sc>&#39;0&#39;</span><span class=p>;</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>verb</span><span class=p>(</span><span class=n>c</span><span class=p>){</span><span class=n>I</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=k>for</span><span class=p>(;</span><span class=n>vt</span><span class=p>[</span><span class=n>i</span><span class=p>];)</span><span class=k>if</span><span class=p>(</span><span class=n>vt</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]</span><span class=o>==</span><span class=n>c</span><span class=p>)</span><span class=n>R</span> <span class=n>i</span><span class=p>;</span><span class=n>R</span> <span class=mi>0</span><span class=p>;}</span>
<span class=n>I</span> <span class=o>*</span><span class=n>wd</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=n>C</span> <span class=o>*</span><span class=n>s</span><span class=p>;{</span><span class=n>I</span> <span class=n>a</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=o>*</span><span class=n>e</span><span class=o>=</span><span class=n>ma</span><span class=p>(</span><span class=n>n</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span><span class=n>C</span> <span class=n>c</span><span class=p>;</span>
 <span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=n>noun</span><span class=p>(</span><span class=n>c</span><span class=o>=</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span><span class=o>?</span><span class=nl>a</span><span class=p>:(</span><span class=n>a</span><span class=o>=</span><span class=n>verb</span><span class=p>(</span><span class=n>c</span><span class=p>))</span><span class=o>?</span><span class=nl>a</span><span class=p>:</span><span class=n>c</span><span class=p>);</span><span class=n>e</span><span class=p>[</span><span class=n>n</span><span class=p>]</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>R</span> <span class=n>e</span><span class=p>;}</span>

<span class=c1>//or
</span><span class=c1></span>
<span class=c1>// for 0..9 - return array with one number inside,
</span><span class=c1>// otherwise return NULL.
</span><span class=c1></span><span class=n>A</span> <span class=n>noun</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>&lt;</span> <span class=sc>&#39;0&#39;</span> <span class=o>||</span> <span class=n>c</span> <span class=o>&gt;</span> <span class=sc>&#39;9&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
  <span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>-</span><span class=sc>&#39;0&#39;</span><span class=p>;</span>
  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// for verbs (&#34;functions&#34;) return their index+1 in the table vt,
</span><span class=c1>// otherwise return NULL.
</span><span class=c1></span><span class=n>A</span> <span class=n>verb</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>vt</span><span class=p>[</span><span class=n>i</span><span class=p>];)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>vt</span><span class=p>[</span><span class=n>i</span><span class=o>++</span><span class=p>]</span> <span class=o>==</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>i</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>I</span> <span class=o>*</span><span class=n>wd</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>s</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>n</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
  <span class=n>I</span> <span class=o>*</span><span class=n>tokens</span> <span class=o>=</span> <span class=n>ma</span><span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// allocate a token per char + 1
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// for each char
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>noun</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span> <span class=p>{</span>
      <span class=n>tokens</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>noun</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span> <span class=c1>// one-digit number literals
</span><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>verb</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span> <span class=p>{</span>
      <span class=n>tokens</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>verb</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span> <span class=c1>// verbs
</span><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>tokens</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>       <span class=c1>// one-letter variables a..z
</span><span class=c1></span>    <span class=p>}</span>
  <span class=p>}</span>
  <span class=n>e</span><span class=p>[</span><span class=n>n</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// null-terminate and return tokens
</span><span class=c1></span>  <span class=k>return</span> <span class=n>e</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>So the parser converts each and every character in the input line to either a noun (numeric literal from 0 to 9), a verb (a one-symbol function) or a variable (&lsquo;a&rsquo;..&lsquo;z&rsquo;). It&rsquo;s very fragile so you should be really careful with the input.</p><p>Now as we have an input string converted into an array of tokens - we can evaluate them.</p><h2 id=eval>eval</h2><p>Evaluator is recursive-decent, with right-side recursion (when right part of the expression is evaluated before the left one):</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>A</span><span class=p>(</span><span class=o>*</span><span class=n>vd</span><span class=p>[])()</span><span class=o>=</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=n>plus</span><span class=p>,</span><span class=n>from</span><span class=p>,</span><span class=n>find</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>rsh</span><span class=p>,</span><span class=n>cat</span><span class=p>},</span>
 <span class=p>(</span><span class=o>*</span><span class=n>vm</span><span class=p>[])()</span><span class=o>=</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=n>id</span><span class=p>,</span><span class=n>size</span><span class=p>,</span><span class=n>iota</span><span class=p>,</span><span class=n>box</span><span class=p>,</span><span class=n>sha</span><span class=p>,</span><span class=mi>0</span><span class=p>};</span>
<span class=n>I</span> <span class=n>st</span><span class=p>[</span><span class=mi>26</span><span class=p>];</span> <span class=n>qp</span><span class=p>(</span><span class=n>a</span><span class=p>){</span><span class=n>R</span>  <span class=n>a</span><span class=o>&gt;=</span><span class=sc>&#39;a&#39;</span><span class=o>&amp;&amp;</span><span class=n>a</span><span class=o>&lt;=</span><span class=sc>&#39;z&#39;</span><span class=p>;}</span><span class=n>qv</span><span class=p>(</span><span class=n>a</span><span class=p>){</span><span class=n>R</span> <span class=n>a</span><span class=o>&lt;</span><span class=sc>&#39;a&#39;</span><span class=p>;}</span>
<span class=n>A</span> <span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=n>I</span> <span class=o>*</span><span class=n>e</span><span class=p>;{</span><span class=n>I</span> <span class=n>a</span><span class=o>=*</span><span class=n>e</span><span class=p>;</span>
 <span class=k>if</span><span class=p>(</span><span class=n>qp</span><span class=p>(</span><span class=n>a</span><span class=p>)){</span><span class=k>if</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>==</span><span class=sc>&#39;=&#39;</span><span class=p>)</span><span class=n>R</span> <span class=n>st</span><span class=p>[</span><span class=n>a</span><span class=o>-</span><span class=sc>&#39;a&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>2</span><span class=p>);</span><span class=n>a</span><span class=o>=</span> <span class=n>st</span><span class=p>[</span> <span class=n>a</span><span class=o>-</span><span class=sc>&#39;a&#39;</span><span class=p>];}</span>
 <span class=n>R</span> <span class=n>qv</span><span class=p>(</span><span class=n>a</span><span class=p>)</span><span class=o>?</span><span class=p>(</span><span class=o>*</span><span class=n>vm</span><span class=p>[</span><span class=n>a</span><span class=p>])(</span><span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>:</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>?</span><span class=p>(</span><span class=o>*</span><span class=n>vd</span><span class=p>[</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>]])(</span><span class=n>a</span><span class=p>,</span><span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>2</span><span class=p>))</span><span class=o>:</span><span class=p>(</span><span class=n>A</span><span class=p>)</span><span class=n>a</span><span class=p>;}</span>

<span class=c1>// or
</span><span class=c1></span>
<span class=n>I</span> <span class=n>st</span><span class=p>[</span><span class=mi>26</span><span class=p>];</span>   <span class=c1>// global variables &#39;a&#39;..&#39;z&#39;
</span><span class=c1></span><span class=n>I</span> <span class=nf>qp</span><span class=p>(</span><span class=n>I</span> <span class=n>a</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// is a letter (variable)?
</span><span class=c1></span>  <span class=k>return</span> <span class=n>a</span> <span class=o>&gt;=</span> <span class=sc>&#39;a&#39;</span> <span class=o>&amp;&amp;</span> <span class=n>a</span> <span class=o>&lt;=</span> <span class=sc>&#39;z&#39;</span><span class=p>;</span>
<span class=p>}</span>
<span class=n>I</span> <span class=nf>qv</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=p>{</span>   <span class=c1>// is a verb symbol?
</span><span class=c1></span>  <span class=k>return</span> <span class=n>a</span> <span class=o>&lt;</span> <span class=sc>&#39;a&#39;</span><span class=p>;</span> 
<span class=p>}</span>
<span class=n>A</span> <span class=nf>ex</span><span class=p>(</span><span class=n>I</span> <span class=o>*</span><span class=n>e</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>a</span> <span class=o>=</span> <span class=o>*</span><span class=n>e</span><span class=p>;</span>            <span class=c1>// take the leftmost token
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>qp</span><span class=p>(</span><span class=n>a</span><span class=p>))</span> <span class=p>{</span>         <span class=c1>// if a variable
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;=&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// ..assignment:
</span><span class=c1></span>      <span class=n>st</span><span class=p>[</span><span class=n>a</span> <span class=o>-</span> <span class=sc>&#39;a&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ex</span><span class=p>(</span><span class=n>e</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>  <span class=c1>// evaluate right side,
</span><span class=c1></span>      <span class=k>return</span> <span class=n>st</span><span class=p>[</span><span class=n>a</span> <span class=o>-</span> <span class=sc>&#39;a&#39;</span><span class=p>];</span>       <span class=c1>// store and return
</span><span class=c1></span>    <span class=p>}</span>
    <span class=n>a</span> <span class=o>=</span> <span class=n>st</span><span class=p>[</span><span class=n>a</span> <span class=o>-</span> <span class=sc>&#39;a&#39;</span><span class=p>];</span>   <span class=c1>// else: load variable
</span><span class=c1></span>  <span class=p>}</span>
  <span class=c1>// &#34;a&#34; now contains the value, or a verb symbol
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>qv</span><span class=p>(</span><span class=n>a</span><span class=p>))</span> <span class=p>{</span>         <span class=c1>// if a verb, it must be monadic
</span><span class=c1></span>    <span class=n>I</span> <span class=o>*</span><span class=n>right</span> <span class=o>=</span> <span class=n>e</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>  <span class=c1>// take the remaining expression
</span><span class=c1></span>    <span class=k>return</span> <span class=p>(</span><span class=o>*</span><span class=n>vm</span><span class=p>[</span><span class=n>a</span><span class=p>])(</span><span class=n>ex</span><span class=p>(</span><span class=n>right</span><span class=p>))</span> <span class=c1>// apply verb and return
</span><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=p>{</span>   <span class=c1>// else, if something follows this token -
</span><span class=c1></span>                       <span class=c1>// it must be a dyadic verb
</span><span class=c1></span>    <span class=c1>// apply it to current token and the one coming after the verb
</span><span class=c1></span>    <span class=k>return</span> <span class=p>(</span><span class=o>*</span><span class=n>vd</span><span class=p>[</span><span class=n>e</span><span class=p>[</span><span class=mi>1</span><span class=p>]])(</span><span class=n>a</span><span class=p>,</span> <span class=n>ex</span><span class=p>(</span><span class=n>e</span><span class=o>+</span><span class=mi>2</span><span class=p>));</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>a</span><span class=p>;</span>          <span class=c1>// else, return noun `a` as is.
</span><span class=c1></span>  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Again, evaluator is completely intolerant to errors and expect only correct input. You see that right-hand side of the expression is always recursively evaluated first. That&rsquo;s because in APL-like languages operators are always applied right-to-left.</p><p>If you are confused about &ldquo;monadic&rdquo; and &ldquo;dyadic&rdquo; verbs - these are merely functions with one (monadic) or two (dyadic) arguments.</p><p>So, once it is clear how evaluation works - let&rsquo;s have a look at the actual verbs, that manipulate our arrays.</p><h2 id=verbs>verbs</h2><p>All verbs take an array or two and return another array, which is a result.</p><p>First, monadic verbs, there&rsquo;s only five of them:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>V1</span><span class=p>(</span><span class=n>id</span><span class=p>){</span><span class=n>R</span> <span class=n>w</span><span class=p>;}</span>
<span class=n>V1</span><span class=p>(</span><span class=n>size</span><span class=p>){</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span><span class=o>*</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=o>?*</span><span class=n>w</span><span class=o>-&gt;</span><span class=nl>d</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V1</span><span class=p>(</span><span class=n>iota</span><span class=p>){</span><span class=n>I</span> <span class=n>n</span><span class=o>=*</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>;</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=o>&amp;</span><span class=n>n</span><span class=p>);</span><span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>i</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V1</span><span class=p>(</span><span class=n>box</span><span class=p>){</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span><span class=o>*</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>=</span><span class=p>(</span><span class=n>I</span><span class=p>)</span><span class=n>w</span><span class=p>;</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>
<span class=n>V1</span><span class=p>(</span><span class=n>sha</span><span class=p>){</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=o>&amp;</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>

<span class=c1>// or
</span><span class=c1></span>
<span class=c1>// Example: id([1,2,3]) -&gt; [1,2,3]
</span><span class=c1></span><span class=n>A</span> <span class=n>id</span><span class=p>(</span><span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span> 
  <span class=k>return</span> <span class=n>w</span><span class=p>;</span>          <span class=c1>// simply returns the given argument
</span><span class=c1></span><span class=p>}</span>

<span class=c1>// Example: size([4,5,6]) -&gt; 3
</span><span class=c1></span><span class=n>A</span> <span class=n>size</span><span class=p>(</span><span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>        <span class=c1>// return size of the vector
</span><span class=c1></span>  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// allocate result
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>)</span> <span class=p>{</span>        <span class=c1>// if w has any rank (is a vector or matrix)
</span><span class=c1></span>    <span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// return its first dimension
</span><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>     <span class=c1>// otherwise, return 1
</span><span class=c1></span>  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// Example: iota(4) -&gt; [0, 1, 2, 3]
</span><span class=c1></span><span class=n>A</span> <span class=n>iota</span><span class=p>(</span><span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>n</span> <span class=o>=</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>      <span class=c1>// number of elements to cretae
</span><span class=c1></span>  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>);</span> <span class=c1>// allocate vector of n elements
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>      <span class=c1>// fill array from 0 to n-1.
</span><span class=c1></span>  <span class=p>}</span>
  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// Example: box([1, 2, 3]) -&gt; [[1, 2, 3]]
</span><span class=c1></span><span class=n>A</span> <span class=n>box</span><span class=p>(</span><span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>  <span class=c1>// allocate a boxed array
</span><span class=c1></span>  <span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>w</span><span class=p>;</span>        <span class=c1>// put w into the boxed array
</span><span class=c1></span>  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// Example: sha([1, 3, 4,
</span><span class=c1></span>                 <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=p>(</span><span class=n>shape</span> <span class=n>of</span> <span class=n>the</span> <span class=n>array</span><span class=p>)</span>
<span class=n>A</span> <span class=n>sha</span><span class=p>(</span><span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>);</span>  <span class=c1>// create array to hold the shape of w
</span><span class=c1></span>  <span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>);</span>   <span class=c1>// copy dimensions of w into result z
</span><span class=c1></span>  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Obviously, in Arthur Whitney&rsquo;s notation these verbs are compact and maybe even easy to read once you know what they are supposed to do.</p><p>Now, the dyadic verbs that operate on two arguments:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>V2</span><span class=p>(</span><span class=n>plus</span><span class=p>){</span><span class=n>I</span> <span class=n>r</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=o>*</span><span class=n>d</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span><span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span>
 <span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>+</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>

<span class=c1>// Example: [1,2,3] + [4,5,6] -&gt; [5,7,9]
</span><span class=c1></span><span class=n>A</span> <span class=n>plus</span><span class=p>(</span><span class=n>A</span> <span class=n>a</span><span class=p>,</span> <span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>n</span> <span class=o>=</span> <span class=n>tr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>);</span> <span class=c1>// how many elements in w
</span><span class=c1></span>  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>);</span> <span class=c1>// create result of the same size
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=c1>// sum elements pairwise
</span><span class=c1></span>  <span class=p>}</span>
  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>V2</span><span class=p>(</span><span class=n>from</span><span class=p>){</span><span class=n>I</span> <span class=n>r</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=o>*</span><span class=n>d</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span>
 <span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>+</span><span class=p>(</span><span class=n>n</span><span class=o>**</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>),</span><span class=n>n</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>

<span class=c1>// Example: 1st from [4,5,6] -&gt; 5
</span><span class=c1></span><span class=n>A</span> <span class=n>from</span><span class=p>(</span><span class=n>A</span> <span class=n>a</span><span class=p>,</span> <span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>n</span> <span class=o>=</span> <span class=n>tr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// one dimension less
</span><span class=c1></span>  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
  <span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span> <span class=o>+</span> <span class=p>(</span><span class=n>n</span> <span class=o>*</span> <span class=p>(</span><span class=o>*</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>)),</span> <span class=n>n</span><span class=p>);</span> <span class=c1>// copy all dimensions but the first one
</span><span class=c1></span>  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>V2</span><span class=p>(</span><span class=n>cat</span><span class=p>){</span><span class=n>I</span> <span class=n>an</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>),</span><span class=n>wn</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>),</span><span class=n>n</span><span class=o>=</span><span class=n>an</span><span class=o>+</span><span class=n>wn</span><span class=p>;</span>
 <span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=o>&amp;</span><span class=n>n</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>an</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>+</span><span class=n>an</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>wn</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>

<span class=c1>// Example: [1,2,3] cat [4,5,6] -&gt; [1,2,3,4,5,6]
</span><span class=c1></span><span class=n>A</span> <span class=n>cat</span><span class=p>(</span><span class=n>A</span> <span class=n>a</span><span class=p>,</span> <span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>an</span> <span class=o>=</span> <span class=n>tr</span><span class=p>(</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span> <span class=n>a</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>);</span>
  <span class=n>I</span> <span class=n>wn</span> <span class=o>=</span> <span class=n>tr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>);</span>
  <span class=n>I</span> <span class=n>n</span> <span class=o>=</span> <span class=n>an</span> <span class=o>+</span> <span class=n>wn</span><span class=p>;</span>
  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>);</span> <span class=c1>// works only with vectors!
</span><span class=c1></span>  <span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span> <span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span> <span class=n>an</span><span class=p>);</span>    <span class=c1>// copy a
</span><span class=c1></span>  <span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>+</span><span class=n>an</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span> <span class=n>wn</span><span class=p>);</span> <span class=c1>// append w
</span><span class=c1></span>  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>V2</span><span class=p>(</span><span class=n>rsh</span><span class=p>){</span><span class=n>I</span> <span class=n>r</span><span class=o>=</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>r</span><span class=o>?*</span><span class=n>a</span><span class=o>-&gt;</span><span class=nl>d</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>),</span><span class=n>wn</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>);</span>
 <span class=n>A</span> <span class=n>z</span><span class=o>=</span><span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>);</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>wn</span><span class=o>=</span><span class=n>n</span><span class=o>&gt;</span><span class=n>wn</span><span class=o>?</span><span class=nl>wn</span><span class=p>:</span><span class=n>n</span><span class=p>);</span>
 <span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=o>-=</span><span class=n>wn</span><span class=p>)</span><span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>+</span><span class=n>wn</span><span class=p>,</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span><span class=n>n</span><span class=p>);</span><span class=n>R</span> <span class=n>z</span><span class=p>;}</span>

<span class=c1>// Example: [2,3] reshape [1,2,    [1,2,3,
</span><span class=c1>//                         3,4] -&gt;  4,1,2]
</span><span class=c1>//   Also:  [4] reshape [1] -&gt; [1,1,1,1] (repeat)
</span><span class=c1></span><span class=n>A</span> <span class=n>rsh</span><span class=p>(</span><span class=n>A</span> <span class=n>a</span><span class=p>,</span> <span class=n>A</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>I</span> <span class=n>r</span> <span class=o>=</span> <span class=n>a</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>?</span> <span class=n>a</span><span class=o>-&gt;</span><span class=nl>d</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// if has dimensions - first dimension, else - 1.
</span><span class=c1></span>  <span class=n>I</span> <span class=n>n</span> <span class=o>=</span> <span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>);</span>     <span class=c1>// length of the resulting array/matrix
</span><span class=c1></span>  <span class=n>I</span> <span class=n>wn</span> <span class=o>=</span> <span class=n>tr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>);</span> <span class=c1>// number of elements in w
</span><span class=c1></span>  <span class=n>A</span> <span class=n>z</span> <span class=o>=</span> <span class=n>ga</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>a</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>);</span> 
  <span class=n>I</span> <span class=n>m</span> <span class=o>=</span> <span class=n>MIN</span><span class=p>(</span><span class=n>wn</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>      <span class=c1>// number of elements in w,
</span><span class=c1></span>                         <span class=c1>// if we don&#39;t have to repeat them.
</span><span class=c1></span>                         <span class=c1>// n otherwise
</span><span class=c1></span>  <span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span> <span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span> <span class=n>m</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>!=</span> <span class=n>m</span><span class=p>)</span> <span class=p>{</span>          <span class=c1>// if we have to repeat...
</span><span class=c1></span>    <span class=n>mv</span><span class=p>(</span><span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=o>+</span><span class=n>m</span><span class=p>,</span> <span class=n>z</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span> <span class=c1>// as it copes left to right - it may
</span><span class=c1></span>                         <span class=c1>// repeat initial elements many times,
</span><span class=c1></span>                         <span class=c1>// until the length is n, as requested.
</span><span class=c1></span>  <span class=p>}</span>
  <span class=k>return</span> <span class=n>z</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h2 id=print>print</h2><p>Finally, printing arrays. I will leave this without any comments, but instead will show the usage of the interpreter:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=c1>// pi(i) print an interger
</span><span class=c1></span><span class=n>pi</span><span class=p>(</span><span class=n>i</span><span class=p>){</span><span class=n>P</span><span class=p>(</span><span class=s>&#34;%d &#34;</span><span class=p>,</span><span class=n>i</span><span class=p>);}</span><span class=n>nl</span><span class=p>(){</span><span class=n>P</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);}</span>
<span class=c1>// pr(w) prints an array, first shape then data, &#34;&lt;&#34; indicates boxing
</span><span class=c1></span><span class=n>pr</span><span class=p>(</span><span class=n>w</span><span class=p>)</span><span class=n>A</span> <span class=n>w</span><span class=p>;{</span><span class=n>I</span> <span class=n>r</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>,</span><span class=o>*</span><span class=n>d</span><span class=o>=</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>d</span><span class=p>,</span><span class=n>n</span><span class=o>=</span><span class=n>tr</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>d</span><span class=p>);</span><span class=n>DO</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>pi</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=n>i</span><span class=p>]));</span><span class=n>nl</span><span class=p>();</span>
 <span class=k>if</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>t</span><span class=p>)</span><span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>P</span><span class=p>(</span><span class=s>&#34;&lt; &#34;</span><span class=p>);</span><span class=n>pr</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span><span class=k>else</span> <span class=n>DO</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>pi</span><span class=p>(</span><span class=n>w</span><span class=o>-&gt;</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]));</span><span class=n>nl</span><span class=p>();}</span>
</code></pre></div><p>And here&rsquo;s the usage of the whole program:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gcc odetoj.c -o j
$ ./j
    2      // numbers
2
    2+3    // plus on numbers
5
    2,3    // array of 2 elements - [2,3]
2          // shape = [2]
2 3        // data =  [2,3]
    a=2,3
2
2 3
    a+4,5  // add two vectors
2
6 8
    ~4     // iota 4
4
0 1 2 3
    ~4+1   // iota (4+1)
0 1 2 3 4
    a=~9
0 1 2 3 4 5 6 7 8
    b=2,3
2
2 3
    a#b      // kind of:
2 3          // 0 1 2
0 1 2 3 4 5  // 3 4 5
    2{b      // 2nd from b
...and so on...
</code></pre></div><p>The interpreter is very limited, but still impressive. But APL family of languages itself is a remarkable part of computer science history, where Arthur Whitney plays a very significant role. I hope this lesson of computational archeology has proven it.</p><p>P.S. As I wrote this article - I was trying to rebuild this interpreter in Rust, with some minor improvements like proper number literals and less fragile handling of data. The result can be found at <a href=https://github.com/zserge/odetoj>https://github.com/zserge/odetoj</a>.</p><p>I hope you’ve enjoyed this article. You can follow – and contribute to – on <a href=https://github.com/zserge>Github</a>, <a href=https://twitter.com/zsergo>Twitter</a> or subscribe via <a href=/rss.xml>rss</a>.</p><p class=date style=text-align:right><em>Mar 31, 2020</em></p><p>See also:
<a href=/posts/cucu-part3/>cucu: a compiler you can understand (3/3)</a> and <a href=/posts/>more</a>.</p></div><footer><p>&copy;2012&ndash;2021 &#183;
<a href=https://zserge.com>Serge Zaitsev</a> &#183;
<a href=mailto:zaitsev.serge@gmail.com>zaitsev.serge@gmail.com</a></p></footer><script>(function(e,t,n,i,s,a,c){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)};a=t.createElement(i);c=t.getElementsByTagName(i)[0];a.async=true;a.src=s;c.parentNode.insertBefore(a,c)})(window,document,"galite","script","https://cdn.jsdelivr.net/npm/ga-lite@2/dist/ga-lite.min.js");galite('create','UA-33644825-1','auto');galite('send','pageview');</script><script>new Image().src='https://nullitics.com/file.gif?r='+encodeURI(document.referrer)+'&d='+screen.width</script><noscript><img src=https://nullitics.com/file.gif></noscript></body></html>